<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æœ¬åœ°å›¾ç‰‡æµè§ˆå™¨</title>
    <style>
        :root {
            --primary-color: #5d7db9;
            --secondary-color: #8aa7d6;
            --accent-color: #ff8a65;
            --light-color: #f9fbfd;
            --dark-color: #2c3e50;
            --border-color: #e1e8ed;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: var(--light-color);
            color: var(--dark-color);
            line-height: 1.6;
            padding: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        h1 {
            font-size: 2.4rem;
            margin-bottom: 10px;
        }
        
        .subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
        }
        
        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 15px; /* Reduced margin to fit breadcrumb */
            padding: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            align-items: center;
        }
        
        button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 18px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        button:hover {
            background-color: var(--secondary-color);
            transform: translateY(-2px);
        }
        
        button.active {
            background-color: var(--accent-color);
        }
        
        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
        }
        
        .file-input-wrapper input[type=file] {
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }
        
        .search-box {
            flex-grow: 1;
            min-width: 200px;
        }
        
        input[type="text"], select {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 1rem;
        }
        
        .view-options {
            display: flex;
            gap: 10px;
        }
        
        .image-counter {
            margin-left: auto;
            font-weight: 600;
            color: var(--primary-color);
        }

        /* é¢åŒ…å±‘å¯¼èˆªæ ·å¼ */
        .breadcrumb-bar {
            display: none; /* é»˜è®¤éšè—ï¼Œè¿›å…¥æ–‡ä»¶å¤¹æ—¶æ˜¾ç¤º */
            padding: 10px 20px;
            margin-bottom: 20px;
            background: #eef2f7;
            border-radius: 8px;
            font-size: 1rem;
            align-items: center;
            gap: 10px;
        }

        .breadcrumb-bar.visible {
            display: flex;
        }

        .breadcrumb-item {
            color: var(--primary-color);
            cursor: pointer;
            font-weight: 600;
        }

        .breadcrumb-item:hover {
            text-decoration: underline;
        }

        .breadcrumb-separator {
            color: #999;
        }

        .breadcrumb-current {
            color: var(--dark-color);
            font-weight: normal;
        }
        
        .masonry-grid:not(.hidden) {
            display: flex !important;
            flex-wrap: wrap !important;
            gap: 15px !important;
            margin-bottom: 30px;
            align-items: flex-start !important;
        }

        .masonry-grid.hidden {
            display: none !important;
        }

        .masonry-grid .image-item {
            flex: 0 0 calc(25% - 11.25px) !important;
            margin-bottom: 15px !important; /* æ¢å¤åº•éƒ¨é—´è· */
            width: calc(25% - 11.25px) !important;
            max-width: calc(25% - 11.25px) !important;
            height: auto !important; /* ç¡®ä¿é«˜åº¦è‡ªé€‚åº” */
        }

        @media (max-width: 1200px) {
            .masonry-grid .image-item {
                flex: 0 0 calc(33.333% - 10px) !important;
                width: calc(33.333% - 10px) !important;
                max-width: calc(33.333% - 10px) !important;
                height: auto !important;
                margin-bottom: 15px !important;
            }
        }

        @media (max-width: 768px) {
            .masonry-grid .image-item {
                flex: 0 0 calc(50% - 7.5px) !important;
                width: calc(50% - 7.5px) !important;
                max-width: calc(50% - 7.5px) !important;
                height: auto !important;
                margin-bottom: 15px !important;
            }

            .controls {
                flex-direction: column;
                align-items: stretch;
            }

            .image-counter {
                margin-left: 0;
                text-align: center;
            }
        }

        @media (max-width: 480px) {
            .masonry-grid .image-item {
                flex: 0 0 100% !important;
                width: 100% !important;
                max-width: 100% !important;
                height: auto !important;
                margin-bottom: 15px !important;
            }
        }

        /* æ¡æ¼«é˜…è§ˆæ¨¡å¼æ ·å¼ */
        .comic-view:not(.hidden) {
            display: block !important;
            margin-bottom: 30px;
            text-align: center;
        }

        .comic-view.hidden {
            display: none !important;
        }

        .comic-view .image-item {
            display: block !important;
            width: 100% !important;
            max-width: 800px !important;
            margin: 0 auto 20px auto !important;
            text-align: center;
            flex: none !important;
        }

        .comic-view .image-item img {
            width: 100% !important;
            height: auto !important;
            max-height: none !important;
            object-fit: contain !important;
            margin: 0 auto !important;
            display: block !important;
        }

        .comic-view .image-info {
            text-align: left;
            width: 100%;
            padding: 12px 0;
        }

        @media (max-width: 900px) {
            .comic-view .image-item {
                max-width: calc(100% - 40px) !important;
                padding: 0 20px;
            }
        }

        @media (max-width: 480px) {
            .comic-view .image-item {
                max-width: calc(100% - 20px) !important;
                padding: 0 10px;
                margin-bottom: 15px !important;
            }
        }
        
        .image-item {
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s, box-shadow 0.3s;
            background: white;
            /* ç§»é™¤é»˜è®¤çš„flexå±æ€§ï¼Œé¿å…å¹²æ‰°ä¸åŒè§†å›¾æ¨¡å¼ */
            height: auto; /* ç¡®ä¿é«˜åº¦è‡ªé€‚åº” */
        }
        
        .image-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        }
        
        .image-item img {
            width: 100%;
            height: auto;
            display: block;
            cursor: pointer;
            transition: transform 0.5s;
        }
        
        .image-item:hover img {
            transform: scale(1.03);
        }
        
        .image-info {
            padding: 12px;
            font-size: 0.9rem;
        }
        
        .image-name {
            font-weight: 600;
            margin-bottom: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .image-path {
            font-size: 0.8rem;
            color: #666;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .folder-view:not(.hidden) {
            display: block !important;
        }

        .folder-view.hidden {
            display: none !important;
        }
        
        .folder-item {
            margin-bottom: 20px;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
        }
        
        .folder-header {
            padding: 15px 20px;
            background-color: #f0f4f8;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background-color 0.2s;
        }

        .folder-header:hover {
            background-color: #e1eaf3;
        }

        .folder-header:hover .folder-name {
            text-decoration: underline;
        }
        
        .folder-name {
            font-weight: 600;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .folder-icon {
            font-size: 1.2rem;
        }
        
        .folder-images {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
            padding: 15px;
        }
        
        .folder-image {
            border-radius: 6px;
            overflow: hidden;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
            aspect-ratio: 1; /* ä¿æŒæ­£æ–¹å½¢ç¼©ç•¥å›¾ */
        }
        
        .folder-image img {
            width: 100%;
            height: 100%;
            object-fit: cover; /* å¡«å……æ­£æ–¹å½¢ */
            display: block;
            cursor: pointer;
            transition: transform 0.3s;
        }

        .folder-image:hover img {
            transform: scale(1.1);
        }
        
        .fullscreen-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            user-select: none;
        }
        
        .fullscreen-container {
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        }
        
        .fullscreen-image-wrapper {
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            position: relative;
        }
        
        .fullscreen-image-wrapper img {
            max-width: 100%;
            max-height: 100%;
            width: auto;
            height: auto;
            object-fit: contain;
            display: block;
            transition: transform 0.1s ease-out;
            transform-origin: center;
        }

        .fullscreen-image-wrapper img.zoomed {
            cursor: grab;
            max-width: none;
            max-height: none;
            object-fit: unset;
        }

        .fullscreen-image-wrapper img.zoomed:active {
            cursor: grabbing;
        }

        .fullscreen-image-wrapper img:not(.zoomed) {
            cursor: zoom-in;
        }
        
        .fullscreen-info {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0);
            color: white;
            padding: 10px 15px;
            text-align: left;
            pointer-events: none;
            z-index: 1002;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8), -1px -1px 2px rgba(0, 0, 0, 0.8);
            font-weight: 600;
        }

        .controls-hint {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.6);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.8rem;
            opacity: 0.9;
            text-shadow: none;
            font-weight: normal;
            pointer-events: none;
            z-index: 1002;
        }
        
        .close-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.5);
            border: none;
            color: white;
            font-size: 2rem;
            cursor: pointer;
            z-index: 1001;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: background 0.3s, transform 0.3s;
            outline: none;
        }
        
        .close-btn:hover {
            background: rgba(0, 0, 0, 0.8);
            transform: rotate(90deg) !important;
        }
        
        .nav-btn {
            position: fixed;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0, 0, 0, 0.5);
            border: none;
            color: white;
            font-size: 2rem;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: background 0.3s, transform 0.3s;
            z-index: 1001;
            outline: none;
        }
        
        .nav-btn:hover {
            background: rgba(0, 0, 0, 0.8);
            transform: translateY(-50%) scale(1.1) !important;
        }
        
        .prev-btn {
            left: 20px;
        }
        
        .next-btn {
            right: 20px;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: var(--primary-color);
            font-size: 1.1rem;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }
        
        .empty-state i {
            font-size: 3rem;
            margin-bottom: 15px;
            color: #ccc;
        }
        
        .hidden {
            display: none !important;
        }
        
        body.fullscreen-active {
            overflow: hidden;
        }

        /* è¿”å›ç½®é¡¶æŒ‰é’®æ ·å¼ */
        .back-to-top {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 50px;
            height: 50px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 1.5rem;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: all 0.3s ease;
            z-index: 999;
            opacity: 0;
            visibility: hidden;
            box-shadow: 0 4px 12px rgba(93, 125, 185, 0.3);
        }

        .back-to-top.visible {
            opacity: 1;
            visibility: visible;
        }

        .back-to-top:hover {
            background: var(--secondary-color);
            transform: translateY(-3px);
            box-shadow: 0 6px 16px rgba(93, 125, 185, 0.4);
        }

        /* å›¾ç‰‡åŠ è½½å ä½ç¬¦æ ·å¼ */
        .image-placeholder {
            width: 100% !important;
            background: #f0f4f8;
            display: flex;
            justify-content: center;
            align-items: center;
            color: #999;
            font-size: 0.9rem;
            position: relative;
            overflow: hidden;
        }

        /* ç½‘æ ¼è§†å›¾å ä½ç¬¦ */
        .masonry-grid .image-placeholder {
            aspect-ratio: 3/4;
            min-height: 200px;
        }

        /* æ¡æ¼«è§†å›¾å ä½ç¬¦ */
        .comic-view .image-placeholder {
            max-width: 800px !important;
            margin: 0 auto 20px auto !important;
            min-height: 400px;
        }

        /* æ–‡ä»¶å¤¹è§†å›¾å ä½ç¬¦ */
        .folder-view .folder-image .image-placeholder {
            aspect-ratio: 1;
            width: 100%;
            height: 100%;
        }

        /* å ä½ç¬¦åŠ¨ç”»æ•ˆæœ */
        .image-placeholder::after {
            content: "";
            position: absolute;
            top: 0;
            left: -100%;
            width: 50%;
            height: 100%;
            background: linear-gradient(
                to right,
                rgba(255, 255, 255, 0) 0%,
                rgba(255, 255, 255, 0.2) 50%,
                rgba(255, 255, 255, 0) 100%
            );
            animation: shimmer 1.5s infinite;
        }

        @keyframes shimmer {
            100% {
                left: 100%;
            }
        }
    </style>
</head>
<body>
    <header>
        <h1>æœ¬åœ°å›¾ç‰‡æµè§ˆå™¨</h1>
        <p class="subtitle">é€‰æ‹©æœ¬åœ°æ–‡ä»¶å¤¹ï¼Œæµè§ˆå’Œç®¡ç†æ‚¨çš„å›¾ç‰‡æ”¶è—</p>
    </header>
    
    <div class="controls">
        <div class="file-input-wrapper">
            <button>
                <i>ğŸ“</i> é€‰æ‹©å›¾ç‰‡æ–‡ä»¶å¤¹
            </button>
            <input type="file" id="folderInput" webkitdirectory directory multiple>
        </div>

          
        <div class="search-box">
            <input type="text" id="searchInput" placeholder="æœç´¢å›¾ç‰‡åç§°..." disabled>
        </div>
        
        <select id="sortSelect" disabled>
            <option value="name">æŒ‰åç§°æ’åº</option>
            <option value="random">éšæœºæ’åº</option>
            <option value="date">æŒ‰æ—¥æœŸæ’åº</option>
        </select>
        
        <div class="view-options">
            <button id="gridViewBtn" class="active" disabled>
                <i>ğŸ–¼ï¸</i> ç½‘æ ¼è§†å›¾
            </button>
            <button id="folderViewBtn" disabled>
                <i>ğŸ“‚</i> æ–‡ä»¶å¤¹è§†å›¾
            </button>
            <button id="comicViewBtn" disabled>
                <i>ğŸ“œ</i> æ¡æ¼«é˜…è§ˆ
            </button>
        </div>
        
        <div class="image-counter">
            å·²åŠ è½½ <span id="imageCount">0</span> å¼ å›¾ç‰‡
        </div>
    </div>

    <div id="breadcrumbBar" class="breadcrumb-bar">
        <span class="breadcrumb-item" id="breadcrumbAll">å…¨éƒ¨å›¾ç‰‡</span>
        <span class="breadcrumb-separator">></span>
        <span class="breadcrumb-current" id="breadcrumbFolder">å½“å‰æ–‡ä»¶å¤¹</span>
    </div>
    
    <div id="masonryView" class="masonry-grid">
        </div>

    <div id="comicView" class="comic-view hidden">
        </div>

    <div id="folderView" class="folder-view hidden">
        </div>
    
    <div id="loadingIndicator" class="loading hidden">
        <p>åŠ è½½æ›´å¤šå›¾ç‰‡ä¸­...</p>
    </div>
    
    <div id="emptyState" class="empty-state">
        <i>ğŸ“·</i>
        <h3>æš‚æ— å›¾ç‰‡</h3>
        <p>è¯·é€‰æ‹©ä¸€ä¸ªåŒ…å«å›¾ç‰‡çš„æ–‡ä»¶å¤¹å¼€å§‹æµè§ˆ</p>
    </div>
    
    <div class="fullscreen-overlay" id="fullscreenOverlay">
        <button class="close-btn" id="closeFullscreen" title="å…³é—­ (Esc)">Ã—</button>
        <button class="nav-btn prev-btn" id="prevBtn" title="ä¸Šä¸€å¼  (â†)">â€¹</button>
        <button class="nav-btn next-btn" id="nextBtn" title="ä¸‹ä¸€å¼  (â†’)">â€º</button>
        <div class="fullscreen-container">
            <div class="fullscreen-image-wrapper" id="imageWrapper">
                <img id="fullscreenImage" src="" alt="å…¨å±å›¾ç‰‡" draggable="false">
            </div>
            <div class="fullscreen-info">
                <p id="fullscreenCaption"></p>
            </div>
            <div class="controls-hint">
                (å•å‡»åˆ‡æ¢100% / æ»šåŠ¨ç¼©æ”¾ / æ‹–æ‹½ç§»åŠ¨)
            </div>
        </div>
    </div>

    <!-- è¿”å›ç½®é¡¶æŒ‰é’® -->
    <button class="back-to-top" id="backToTop" title="è¿”å›é¡¶éƒ¨">â†‘</button>

    <script>
        // çŠ¶æ€ç®¡ç†
        let state = {
            images: [],
            filteredImages: [],
            currentView: 'grid', // 'grid', 'folder', 'comic'
            activeFolder: null,  // å½“å‰è¿›å…¥çš„ç‰¹å®šæ–‡ä»¶å¤¹ï¼Œnull è¡¨ç¤ºæŸ¥çœ‹æ‰€æœ‰
            sortBy: 'name',
            searchQuery: '',
            currentPage: 1,
            itemsPerPage: 20, // å¢åŠ æ¯é¡µæ˜¾ç¤ºæ•°é‡ï¼Œå‡å°‘é¢‘ç¹åŠ è½½
            fullscreenIndex: 0,
            urlCache: new Map(), // ç¼“å­˜URLå¯¹è±¡
            urlCreationTime: new Map(), // è®°å½•URLåˆ›å»ºæ—¶é—´ï¼Œç”¨äºå®‰å…¨æ¸…ç†
            loadedImages: new Set(), // è®°å½•å·²åŠ è½½çš„å›¾ç‰‡
            folderCache: new Map(), // ç¼“å­˜æ–‡ä»¶å¤¹åˆ†ç»„æ•°æ®
            isViewSwitching: false, // è§†å›¾åˆ‡æ¢æ ‡è¯†
            maxCacheSize: 300, // æœ€å¤§ç¼“å­˜æ•°é‡
            urlRevokeDelay: 30000, // 30ç§’æœªä½¿ç”¨åˆ™æ¸…ç†
            memoryWarningThreshold: 500, // å†…å­˜è­¦å‘Šé˜ˆå€¼ï¼ˆMBï¼‰
            lazyLoadEnabled: true, // å¯ç”¨æ‡’åŠ è½½
            timers: [], // å®šæ—¶å™¨ç®¡ç†æ•°ç»„
            intervals: [] // Intervalå®šæ—¶å™¨ç®¡ç†æ•°ç»„
        };

        // ç¼©æ”¾å’Œæ‹–æ‹½çŠ¶æ€
        let zoomState = {
            isZoomed: false,
            scale: 1,
            panning: false,
            pointX: 0,
            pointY: 0,
            translateX: 0,
            translateY: 0,
            hasMoved: false
        };

        // è§†å›¾åˆ‡æ¢æ§åˆ¶çŠ¶æ€
        let viewSwitchProtection = {
            isSwitching: false,
            startTime: 0,
            protectionDuration: 2000 // 2ç§’ä¿æŠ¤æ—¶é—´
        };

        // DOM å…ƒç´ 
        const elements = {
            folderInput: document.getElementById('folderInput'),
            searchInput: document.getElementById('searchInput'),
            sortSelect: document.getElementById('sortSelect'),
            gridViewBtn: document.getElementById('gridViewBtn'),
            folderViewBtn: document.getElementById('folderViewBtn'),
            comicViewBtn: document.getElementById('comicViewBtn'),
            masonryView: document.getElementById('masonryView'),
            comicView: document.getElementById('comicView'),
            folderView: document.getElementById('folderView'),
            breadcrumbBar: document.getElementById('breadcrumbBar'),
            breadcrumbAll: document.getElementById('breadcrumbAll'),
            breadcrumbFolder: document.getElementById('breadcrumbFolder'),
            imageCount: document.getElementById('imageCount'),
            loadingIndicator: document.getElementById('loadingIndicator'),
            emptyState: document.getElementById('emptyState'),
            fullscreenOverlay: document.getElementById('fullscreenOverlay'),
            imageWrapper: document.getElementById('imageWrapper'),
            fullscreenImage: document.getElementById('fullscreenImage'),
            fullscreenCaption: document.getElementById('fullscreenCaption'),
            closeFullscreen: document.getElementById('closeFullscreen'),
            prevBtn: document.getElementById('prevBtn'),
            nextBtn: document.getElementById('nextBtn'),
            backToTop: document.getElementById('backToTop')
        };

        // åˆå§‹åŒ–
        function init() {
            state.images = [];
            state.filteredImages = [];
            state.isLoading = false; // æ·»åŠ åŠ è½½çŠ¶æ€æ ‡è¯†
            renderImages();
            setupEventListeners();

            // åˆå§‹åŒ–æ‡’åŠ è½½
            initLazyLoad();

            // é¡µé¢å¸è½½æ—¶æ¸…ç†èµ„æº
            window.addEventListener('beforeunload', cleanupResources);

            // ç›‘å¬é¡µé¢å¯è§æ€§å˜åŒ–ï¼Œä¼˜åŒ–æ€§èƒ½
            document.addEventListener('visibilitychange', handleVisibilityChange);

            // å¯ç”¨å®šæœŸæ¸…ç†æœºåˆ¶
            managedSetInterval(() => {
                if (!document.hidden) {
                    cleanupUnusedUrls();
                }
            }, 120000); // æ¯2åˆ†é’Ÿæ¸…ç†ä¸€æ¬¡

            console.log('ğŸš€ æœ¬åœ°å›¾ç‰‡æµè§ˆå™¨å·²åˆå§‹åŒ–');
            console.log('ğŸ“Š å†…å­˜ä¼˜åŒ–ç­–ç•¥:');
            console.log('  - å›¾ç‰‡URLæŒ‰éœ€åˆ›å»º');
            console.log('  - LRUç¼“å­˜ç®¡ç†ï¼Œæœ€å¤§ç¼“å­˜' + state.maxCacheSize + 'ä¸ªURL');
            console.log('  - æ‡’åŠ è½½æœºåˆ¶ï¼ŒåªåŠ è½½å¯è§åŒºåŸŸå›¾ç‰‡');
            console.log('  - è‡ªåŠ¨å†…å­˜ç›‘æ§å’Œæ¸…ç†');
            console.log('  - å®šæ—¶å™¨ç®¡ç†å’ŒObserverèµ„æºæ¸…ç†');

            // å®šæœŸæ€§èƒ½ç›‘æ§
            managedSetInterval(() => {
                const cacheSize = state.urlCache.size;
                const loadedCount = state.loadedImages.size;
                const estimatedMemory = estimateMemoryUsage();

                if (cacheSize > 0) {
                    console.log(`ğŸ“ˆ æ€§èƒ½ç›‘æ§: ç¼“å­˜${cacheSize}ä¸ªURL, å·²åŠ è½½${loadedCount}å¼ å›¾ç‰‡, é¢„ä¼°å†…å­˜${estimatedMemory}MB`);
                }
            }, 30000); // æ¯30ç§’ç›‘æ§ä¸€æ¬¡
        }

        // å†…å­˜ä½¿ç”¨ä¼°ç®—ï¼ˆæ›´ç²¾ç¡®ç‰ˆæœ¬ï¼‰
        function estimateMemoryUsage() {
            let totalSize = 0;
            const cacheCount = state.urlCache.size;

            // åŸºäºç¼“å­˜æ•°é‡å’Œå¹³å‡å¤§å°ä¼°ç®—
            if (cacheCount === 0) return 0;

            // åŸºäºå®é™…ç¼“å­˜çš„å›¾ç‰‡æ•°é‡åŠ¨æ€ä¼°ç®—å¹³å‡å¤§å°
            // å°é›†åˆï¼šå‡è®¾å¹³å‡1MBï¼Œå¤§é›†åˆï¼šå¹³å‡2MB
            const avgSizePerImage = cacheCount < 50 ? 1 : 2;
            totalSize = Math.round(cacheCount * avgSizePerImage);

            console.log(`ğŸ“Š å†…å­˜ä¼°ç®—: ${cacheCount}ä¸ªç¼“å­˜URL, çº¦${totalSize}MB`);
            return totalSize;
        }

        // å†…å­˜æ£€æŸ¥å’Œæ¸…ç†
        function checkMemoryUsage() {
            const estimatedMemory = estimateMemoryUsage();

            if (estimatedMemory > state.memoryWarningThreshold) {
                console.warn(`âš ï¸ å†…å­˜ä½¿ç”¨è¿‡é«˜ï¼Œçº¦ ${estimatedMemory}MBï¼Œå¼€å§‹æ¸…ç†...`);
                cleanupOldUrls();

                // å¦‚æœå†…å­˜è¿˜æ˜¯è¿‡é«˜ï¼Œæ˜¾ç¤ºè­¦å‘Š
                if (estimateMemoryUsage() > state.memoryWarningThreshold * 1.5) {
                    showMemoryWarning(estimatedMemory);
                }
            }
        }

        // æ˜¾ç¤ºå†…å­˜è­¦å‘Š
        function showMemoryWarning(memoryMB) {
            const warning = document.createElement('div');
            warning.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #ff6b6b;
                color: white;
                padding: 15px 20px;
                border-radius: 8px;
                z-index: 3000;
                max-width: 300px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            `;
            warning.innerHTML = `
                <strong>å†…å­˜ä½¿ç”¨è­¦å‘Š</strong><br>
                ä¼°ç®—å†…å­˜ä½¿ç”¨: ${memoryMB}MB<br>
                <small>å»ºè®®å‡å°‘æ–‡ä»¶å¤¹ä¸­çš„å›¾ç‰‡æ•°é‡æˆ–åˆ·æ–°é¡µé¢</small>
            `;

            document.body.appendChild(warning);

            // 5ç§’åè‡ªåŠ¨ç§»é™¤
            managedSetTimeout(() => {
                if (warning.parentNode) {
                    warning.parentNode.removeChild(warning);
                }
            }, 5000);
        }

        // æ¸…ç†èµ„æº
        function cleanupResources() {
            clearUrlCache();
            state.urlCreationTime.clear(); // æ¸…ç†URLåˆ›å»ºæ—¶é—´è®°å½•
            state.folderCache.clear();
            state.loadedImages.clear();

            // æ¸…ç†æ–‡ä»¶å¤¹Observer
            cleanupFolderObservers();
            if (state.folderImageObserver) {
                state.folderImageObserver.disconnect();
                state.folderImageObserver = null;
            }

            // æ¸…ç†æ‰€æœ‰å®šæ—¶å™¨
            clearAllTimers();

            // æ–­å¼€æ— é™æ»šåŠ¨è§‚å¯Ÿå™¨
            if (state.infiniteScrollObserver) {
                state.infiniteScrollObserver.disconnect();
                console.log('ğŸ”Œ å·²æ–­å¼€æ— é™æ»šåŠ¨è§‚å¯Ÿå™¨');
            }

            // æ¸…ç†æ‰€æœ‰æ‡’åŠ è½½è§‚å¯Ÿå™¨
            document.querySelectorAll('img[data-observer]').forEach(img => {
                if (img._lazyObserver) {
                    img._lazyObserver.disconnect();
                    delete img._lazyObserver;
                }
            });

            // æ¸…ç†æ‰€æœ‰åŠ¨æ€åˆ›å»ºçš„äº‹ä»¶ç›‘å¬å™¨
            // ç”±äºå›¾ç‰‡å…ƒç´ ä¼šè¢«ç§»é™¤ï¼Œå®ƒä»¬çš„äº‹ä»¶ç›‘å¬å™¨ä¹Ÿä¼šè¢«åƒåœ¾å›æ”¶
            // ä½†ä¸ºäº†ç¡®ä¿å®Œå…¨æ¸…ç†ï¼Œæˆ‘ä»¬æ¸…ç©ºå®¹å™¨
            if (elements.masonryView) {
                elements.masonryView.innerHTML = '';
            }
            if (elements.comicView) {
                elements.comicView.innerHTML = '';
            }
            if (elements.folderView) {
                elements.folderView.innerHTML = '';
            }

            console.log('ğŸ§¹ å·²æ¸…ç†æ‰€æœ‰èµ„æºï¼šURLç¼“å­˜ã€å®šæ—¶å™¨ã€è§‚å¯Ÿå™¨å’ŒDOMå…ƒç´ ');
        }

        // å®šæ—¶å™¨ç®¡ç†å‡½æ•°
        function managedSetTimeout(callback, delay) {
            const timerId = setTimeout(() => {
                // ä»ç®¡ç†æ•°ç»„ä¸­ç§»é™¤
                const index = state.timers.indexOf(timerId);
                if (index > -1) {
                    state.timers.splice(index, 1);
                }
                callback();
            }, delay);

            // æ·»åŠ åˆ°ç®¡ç†æ•°ç»„
            state.timers.push(timerId);
            return timerId;
        }

        function managedSetInterval(callback, delay) {
            const intervalId = setInterval(callback, delay);
            state.intervals.push(intervalId);
            return intervalId;
        }

        function clearAllTimers() {
            // æ¸…ç†æ‰€æœ‰setTimeout
            state.timers.forEach(timerId => clearTimeout(timerId));
            state.timers = [];

            // æ¸…ç†æ‰€æœ‰setInterval
            state.intervals.forEach(intervalId => clearInterval(intervalId));
            state.intervals = [];

            console.log('â° å·²æ¸…ç†æ‰€æœ‰å®šæ—¶å™¨');
        }

        // å¤„ç†é¡µé¢å¯è§æ€§å˜åŒ–
        function handleVisibilityChange() {
            if (document.hidden) {
                // é¡µé¢éšè—æ—¶æš‚åœä¸å¿…è¦çš„æ“ä½œ
                console.log('é¡µé¢éšè—ï¼Œæš‚åœæ€§èƒ½å¯†é›†å‹æ“ä½œ');
            } else {
                // é¡µé¢æ˜¾ç¤ºæ—¶æ¢å¤æ“ä½œ
                console.log('é¡µé¢æ˜¾ç¤ºï¼Œæ¢å¤æ­£å¸¸æ“ä½œ');
            }
        }

        // LRUç¼“å­˜æ¸…ç† - æ¸…ç†æœ€æ—§çš„URL
        function cleanupOldUrls() {
            if (state.urlCache.size <= state.maxCacheSize) {
                return; // ç¼“å­˜å¤§å°åœ¨é™åˆ¶å†…ï¼Œä¸éœ€è¦æ¸…ç†
            }

            const toCleanup = state.urlCache.size - state.maxCacheSize + 10; // å¤šæ¸…ç†ä¸€äº›ï¼Œé¿å…é¢‘ç¹æ¸…ç†

            // æŒ‰åˆ›å»ºæ—¶é—´æ’åºï¼Œä¼˜å…ˆæ¸…ç†æœ€æ—§çš„URL
            const keysWithTime = Array.from(state.urlCache.keys()).map(key => ({
                key,
                creationTime: state.urlCreationTime.get(key) || 0
            }));

            keysWithTime.sort((a, b) => a.creationTime - b.creationTime);
            const keysToRemove = keysWithTime.slice(0, toCleanup).map(item => item.key);

            console.log(`ğŸ§¹ LRUæ¸…ç†: å‡†å¤‡æ¸…ç† ${keysToRemove.length} ä¸ªæ—§URL`);

            keysToRemove.forEach(key => {
                try {
                    const url = state.urlCache.get(key);
                    if (url && url.startsWith('blob:')) {
                        URL.revokeObjectURL(url);
                    }
                    state.urlCache.delete(key);
                    state.urlCreationTime.delete(key); // åŒæ—¶æ¸…ç†æ—¶é—´è®°å½•
                } catch (e) {
                    console.warn('æ¸…ç†æ—§URLå¤±è´¥:', e, key);
                }
            });

            console.log(`âœ… LRUæ¸…ç†å®Œæˆï¼Œå½“å‰ç¼“å­˜ ${state.urlCache.size} ä¸ªURL`);
            checkMemoryUsage();
        }

        // æ¸…ç†æœªä½¿ç”¨çš„URL - ä¼˜åŒ–ç‰ˆæœ¬
        function cleanupUnusedUrls() {
            const now = Date.now();
            const keys = Array.from(state.urlCache.keys());
            const usedKeys = new Set();

            // æ”¶é›†å½“å‰å¯è§çš„å›¾ç‰‡key
            document.querySelectorAll('img:not([data-lazy="true"])').forEach(img => {
                if (img.dataset.fileKey) {
                    usedKeys.add(img.dataset.fileKey);
                }
            });

            // æ”¶é›†å…¨å±æ˜¾ç¤ºçš„å›¾ç‰‡key
            const fullscreenImg = document.getElementById('fullscreenImage');
            if (fullscreenImg && fullscreenImg.dataset.fileKey) {
                usedKeys.add(fullscreenImg.dataset.fileKey);
            }

            // ä¼˜å…ˆç§»é™¤è¶…è¿‡ç¼“å­˜å¤§å°çš„æœªä½¿ç”¨URL
            if (keys.length > state.maxCacheSize) {
                // æŒ‰åˆ›å»ºæ—¶é—´æ’åºï¼Œå…ˆæ¸…ç†æœ€æ—©çš„
                keys.sort((a, b) => state.urlCreationTime.get(a) - state.urlCreationTime.get(b))
                    .forEach(key => {
                        if (!usedKeys.has(key) && keys.length > state.maxCacheSize) {
                            URL.revokeObjectURL(state.urlCache.get(key));
                            state.urlCache.delete(key);
                            state.urlCreationTime.delete(key);
                        }
                    });
            }

            // æ¸…ç†è¿‡æœŸæœªä½¿ç”¨çš„URL
            keys.forEach(key => {
                if (!usedKeys.has(key) && now - state.urlCreationTime.get(key) > state.urlRevokeDelay) {
                    URL.revokeObjectURL(state.urlCache.get(key));
                    state.urlCache.delete(key);
                    state.urlCreationTime.delete(key);
                }
            });
        }

        // æ¸…ç†URLç¼“å­˜
        function clearUrlCache() {
            state.urlCache.forEach((url, key) => {
                try {
                    URL.revokeObjectURL(url);
                } catch (e) {
                    console.warn('æ¸…ç†URLæ—¶å‡ºé”™:', e);
                }
            });
            state.urlCache.clear();
            state.urlCreationTime.clear(); // åŒæ—¶æ¸…ç†åˆ›å»ºæ—¶é—´è®°å½•
        }

        // è·å–æˆ–åˆ›å»ºå›¾ç‰‡URL - æŒ‰éœ€åŠ è½½ç‰ˆæœ¬
        function getImageUrl(file) {
            const fileKey = `${file.name}_${file.size}_${file.lastModified}`;

            // å¦‚æœå·²ç¼“å­˜ï¼Œç›´æ¥è¿”å›
            if (state.urlCache.has(fileKey)) {
                // å°†è¿™ä¸ªURLç§»åˆ°æœ€åï¼ˆLRUç­–ç•¥ï¼‰
                const url = state.urlCache.get(fileKey);
                state.urlCache.delete(fileKey);
                state.urlCache.set(fileKey, url);
                return url;
            }

            // æ£€æŸ¥å†…å­˜ä½¿ç”¨æƒ…å†µï¼Œå¿…è¦æ—¶å…ˆæ¸…ç†
            checkMemoryUsage();

            try {
                // éªŒè¯æ–‡ä»¶å¯¹è±¡
                if (!file || !(file instanceof File) || !file.type.startsWith('image/')) {
                    throw new Error('æ— æ•ˆçš„å›¾ç‰‡æ–‡ä»¶');
                }

                console.log('ğŸ“¸ æŒ‰éœ€åˆ›å»ºblob URLï¼Œæ–‡ä»¶ä¿¡æ¯:', {
                    name: file.name,
                    size: formatFileSize(file.size),
                    type: file.type,
                    cacheSize: state.urlCache.size
                });

                // åˆ›å»ºblob URL
                const url = URL.createObjectURL(file);

                // éªŒè¯URLæ˜¯å¦åˆ›å»ºæˆåŠŸ
                if (!url || !url.startsWith('blob:')) {
                    throw new Error('åˆ›å»ºblob URLå¤±è´¥');
                }

                // è®°å½•åˆ›å»ºæ—¶é—´
                const currentTime = Date.now();
                state.urlCache.set(fileKey, url);
                state.urlCreationTime.set(fileKey, currentTime);

                console.log('âœ… æˆåŠŸåˆ›å»ºå›¾ç‰‡URL:', file.name, 'åˆ›å»ºæ—¶é—´:', currentTime);

                // æ£€æŸ¥æ˜¯å¦éœ€è¦æ¸…ç†æ—§ç¼“å­˜
                if (state.urlCache.size > state.maxCacheSize) {
                    managedSetTimeout(() => cleanupOldUrls(), 1000);
                }

                return url;

            } catch (error) {
                console.error('âŒ åˆ›å»ºå›¾ç‰‡URLå¤±è´¥:', file.name, error);
                return null;
            }
        }

        // ç”Ÿæˆå›¾ç‰‡å”¯ä¸€æ ‡è¯†
        function getImageKey(file) {
            return `${file.name}_${file.size}_${file.lastModified}`;
        }

        // å»¶è¿ŸåŠ è½½å›¾ç‰‡å®ç°
        function lazyLoadImage(img) {
            if (img.dataset.lazy === "false" || img.classList.contains('loaded')) return;

            const key = img.dataset.fileKey;
            if (!key) return;

            // æŸ¥æ‰¾å¯¹åº”çš„å›¾ç‰‡æ–‡ä»¶
            const image = state.images.find(img => getImageKey(img.file) === key);
            if (!image) return;

            // ä»ç¼“å­˜è·å–æˆ–åˆ›å»ºURL
            if (state.urlCache.has(key)) {
                img.src = state.urlCache.get(key);
                state.urlCreationTime.set(key, Date.now());
            } else {
                const url = URL.createObjectURL(image.file);
                img.src = url;
                state.urlCache.set(key, url);
                state.urlCreationTime.set(key, Date.now());
            }

            img.dataset.lazy = "false";
        }

        // æ£€æŸ¥å¹¶åŠ è½½è§†å£ä¸­çš„å›¾ç‰‡
        function checkLazyLoad() {
            const lazyImages = document.querySelectorAll('img[data-lazy="true"]');

            lazyImages.forEach(img => {
                const rect = img.getBoundingClientRect();
                // å½“å›¾ç‰‡è¿›å…¥è§†å£æˆ–åœ¨è§†å£é™„è¿‘æ—¶åŠ è½½
                if (rect.top < window.innerHeight + 500 && rect.bottom > -200) {
                    lazyLoadImage(img);
                }
            });

            // æ¸…ç†é•¿æ—¶é—´æœªä½¿ç”¨çš„URL
            cleanupUnusedUrls();
        }

        // åˆå§‹åŒ–æ‡’åŠ è½½ç›‘å¬
        function initLazyLoad() {
            // åˆå§‹åŠ è½½å¯è§åŒºåŸŸå›¾ç‰‡
            checkLazyLoad();

            // æ»šåŠ¨æ—¶æ£€æŸ¥
            window.addEventListener('scroll', throttle(checkLazyLoad, 200));

            // è§†å›¾åˆ‡æ¢æ—¶æ£€æŸ¥
            ['gridViewBtn', 'folderViewBtn', 'comicViewBtn'].forEach(btnId => {
                const btn = document.getElementById(btnId);
                if (btn) {
                    btn.addEventListener('click', () => {
                        setTimeout(checkLazyLoad, 100);
                    });
                }
            });
        }

        // èŠ‚æµå‡½æ•°ï¼Œä¼˜åŒ–æ»šåŠ¨æ€§èƒ½
        function throttle(func, delay) {
            let lastCall = 0;
            return function(...args) {
                const now = new Date().getTime();
                if (now - lastCall < delay) return;
                lastCall = now;
                return func(...args);
            };
        }

        // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
        function setupEventListeners() {
            // æ–‡ä»¶å¤¹é€‰æ‹©
            elements.folderInput.addEventListener('change', handleFolderSelect);
            
            // æœç´¢
            elements.searchInput.addEventListener('input', debounce(() => {
                state.searchQuery = elements.searchInput.value;
                filterAndSortImages();
                renderImages();
            }, 300));
            
            // æ’åº
            elements.sortSelect.addEventListener('change', () => {
                state.sortBy = elements.sortSelect.value;
                filterAndSortImages();
                renderImages();
            });
            
            // è§†å›¾åˆ‡æ¢ (ç‚¹å‡»é¡¶éƒ¨æŒ‰é’®è§†ä¸ºé‡ç½®åˆ°æŸ¥çœ‹æ‰€æœ‰)
            elements.gridViewBtn.addEventListener('click', () => {
                // ç½‘æ ¼è§†å›¾ï¼šé‡ç½®æ‰€æœ‰è¿‡æ»¤çŠ¶æ€
                state.activeFolder = null; // é‡ç½®æ–‡ä»¶å¤¹è¿‡æ»¤
                state.searchQuery = ''; // æ¸…ç©ºæœç´¢
                elements.searchInput.value = '';
                switchView('grid');
            });

            elements.folderViewBtn.addEventListener('click', () => {
                // æ–‡ä»¶å¤¹è§†å›¾ï¼šé‡ç½®æ‰€æœ‰è¿‡æ»¤çŠ¶æ€ï¼Œæ˜¾ç¤ºæ‰€æœ‰æ–‡ä»¶å¤¹åˆ†ç»„
                state.activeFolder = null; // é‡ç½®æ–‡ä»¶å¤¹è¿‡æ»¤
                state.searchQuery = ''; // æ¸…ç©ºæœç´¢
                elements.searchInput.value = '';
                switchView('folder');
            });

            elements.comicViewBtn.addEventListener('click', () => {
                // æ¡æ¼«è§†å›¾ï¼šä¿æŒå½“å‰ä¸Šä¸‹æ–‡ï¼ˆactiveFolderå’Œæœç´¢çŠ¶æ€ï¼‰
                // è¿™æ ·å¯ä»¥åœ¨æ–‡ä»¶å¤¹å†…ç»§ç»­ä½¿ç”¨æ¡æ¼«æ¨¡å¼æµè§ˆ
                console.log('åˆ‡æ¢åˆ°æ¡æ¼«è§†å›¾ï¼Œå½“å‰çŠ¶æ€:', {
                    activeFolder: state.activeFolder,
                    searchQuery: state.searchQuery
                });
                switchView('comic');
            });
            
            // é¢åŒ…å±‘å¯¼èˆªç‚¹å‡»
            elements.breadcrumbAll.addEventListener('click', () => {
                state.activeFolder = null;
                // è¿”å›åˆ°ä¹‹å‰çš„è§†å›¾æ¨¡å¼ï¼Œé€šå¸¸æ˜¯æ–‡ä»¶å¤¹è§†å›¾æˆ–æ€»ç½‘æ ¼è§†å›¾
                // è¿™é‡Œé€»è¾‘ï¼šå¦‚æœä¹‹å‰æ˜¯åœ¨æ–‡ä»¶å¤¹é‡Œï¼Œç‚¹å‡»è¿”å›é€šå¸¸æ˜¯å›åˆ°æ–‡ä»¶å¤¹åˆ—è¡¨
                switchView('folder'); 
            });

            // å…¨å±æŸ¥çœ‹ä¸äº¤äº’
            elements.closeFullscreen.addEventListener('click', closeFullscreen);
            elements.prevBtn.addEventListener('click', (e) => { e.stopPropagation(); showPrevImage(); });
            elements.nextBtn.addEventListener('click', (e) => { e.stopPropagation(); showNextImage(); });
            
            elements.fullscreenOverlay.addEventListener('click', (e) => {
                if (e.target === elements.fullscreenOverlay || e.target === elements.imageWrapper) {
                    closeFullscreen();
                }
            });
            
            setupImageInteractions();

            // è¿”å›ç½®é¡¶æŒ‰é’®
            elements.backToTop.addEventListener('click', () => {
                window.scrollTo({
                    top: 0,
                    behavior: 'smooth'
                });
            });

            // ä¼˜åŒ–çš„æ— é™æ»šåŠ¨ - ä½¿ç”¨Intersection Observer
            setupInfiniteScroll();
            window.addEventListener('scroll', debounce(() => {
                // æ›´æ–°è¿”å›ç½®é¡¶æŒ‰é’®æ˜¾ç¤ºçŠ¶æ€
                updateBackToTopButton();
            }, 200));
            
            // é”®ç›˜å¯¼èˆª
            document.addEventListener('keydown', (e) => {
                if (elements.fullscreenOverlay.style.display === 'flex') {
                    if (e.key === 'Escape') closeFullscreen();
                    if (e.key === 'ArrowLeft') showPrevImage();
                    if (e.key === 'ArrowRight') showNextImage();
                }
            });
        }

        // è®¾ç½®å›¾ç‰‡ç¼©æ”¾å’Œæ‹–æ‹½äº¤äº’
        function setupImageInteractions() {
            const img = elements.fullscreenImage;
            const wrapper = elements.imageWrapper;

            img.addEventListener('click', (e) => {
                if (zoomState.hasMoved) {
                    zoomState.hasMoved = false;
                    return;
                }
                toggleZoom(e);
            });

            wrapper.addEventListener('wheel', (e) => {
                e.preventDefault();
                const delta = e.deltaY > 0 ? 0.9 : 1.1;
                let newScale = zoomState.scale * delta;
                if (newScale < 0.1) newScale = 0.1;
                if (newScale > 10) newScale = 10;
                zoomState.scale = newScale;
                enableZoomMode();
                updateImageTransform();
            }, { passive: false });

            img.addEventListener('mousedown', (e) => {
                if (!zoomState.isZoomed && zoomState.scale <= 1) return;
                e.preventDefault();
                zoomState.panning = true;
                zoomState.pointX = e.clientX - zoomState.translateX;
                zoomState.pointY = e.clientY - zoomState.translateY;
                zoomState.hasMoved = false;
                img.style.cursor = 'grabbing';
            });

            window.addEventListener('mousemove', (e) => {
                if (!zoomState.panning) return;
                e.preventDefault();
                const newX = e.clientX - zoomState.pointX;
                const newY = e.clientY - zoomState.pointY;
                if (Math.abs(newX - zoomState.translateX) > 2 || Math.abs(newY - zoomState.translateY) > 2) {
                    zoomState.hasMoved = true;
                }
                zoomState.translateX = newX;
                zoomState.translateY = newY;
                updateImageTransform();
            });

            window.addEventListener('mouseup', () => {
                if (zoomState.panning) {
                    zoomState.panning = false;
                    img.style.cursor = zoomState.isZoomed || zoomState.scale > 1 ? 'grab' : 'zoom-in';
                }
            });
        }

        function toggleZoom(e) {
            if (zoomState.isZoomed) {
                resetZoom();
            } else {
                zoomState.isZoomed = true;
                zoomState.scale = 1;
                zoomState.translateX = 0;
                zoomState.translateY = 0;
                enableZoomMode();
                updateImageTransform();
            }
        }

        function enableZoomMode() {
            elements.fullscreenImage.classList.add('zoomed');
        }

        function resetZoom() {
            zoomState.isZoomed = false;
            zoomState.scale = 1;
            zoomState.translateX = 0;
            zoomState.translateY = 0;
            elements.fullscreenImage.classList.remove('zoomed');
            elements.fullscreenImage.style.transform = '';
        }

        function updateImageTransform() {
            if (elements.fullscreenImage.classList.contains('zoomed')) {
                 elements.fullscreenImage.style.transform = 
                    `translate(${zoomState.translateX}px, ${zoomState.translateY}px) scale(${zoomState.scale})`;
            }
        }

        // å¤„ç†æ–‡ä»¶å¤¹é€‰æ‹© - å†…å­˜ä¼˜åŒ–ç‰ˆæœ¬
        function handleFolderSelect(event) {
            const files = Array.from(event.target.files);
            const imageFiles = files.filter(file => file.type.startsWith('image/'));

            if (imageFiles.length === 0) {
                alert('æ‰€é€‰æ–‡ä»¶å¤¹ä¸­æ²¡æœ‰æ‰¾åˆ°å›¾ç‰‡æ–‡ä»¶');
                return;
            }

            // æ£€æŸ¥å›¾ç‰‡æ•°é‡ï¼Œè­¦å‘Šç”¨æˆ·
            if (imageFiles.length > 1000) {
                const confirm = window.confirm(
                    `æ£€æµ‹åˆ° ${imageFiles.length} å¼ å›¾ç‰‡ï¼Œè¿™å¯èƒ½ä¼šå ç”¨å¤§é‡å†…å­˜ã€‚\n` +
                    `å»ºè®®å°†å›¾ç‰‡åˆ†åˆ°è¾ƒå°çš„æ–‡ä»¶å¤¹ä¸­ï¼ˆæ¯ä¸ªæ–‡ä»¶å¤¹ä¸è¶…è¿‡200å¼ ï¼‰ã€‚\n\n` +
                    `æ˜¯å¦ç»§ç»­åŠ è½½ï¼Ÿ`
                );
                if (!confirm) {
                    return;
                }
            }

            // å®‰å…¨æ¸…ç†ä¹‹å‰çš„URLç¼“å­˜ - å¢åŠ å»¶è¿Ÿé¿å…ä¸­æ–­æ­£åœ¨æ˜¾ç¤ºçš„å›¾ç‰‡
            managedSetTimeout(() => {
                clearUrlCache();
                state.folderCache.clear();
                state.loadedImages.clear();
                console.log('âœ… å·²æ¸…ç†æ—§çš„å›¾ç‰‡ç¼“å­˜ï¼Œå‡†å¤‡åŠ è½½æ–°æ–‡ä»¶å¤¹');
            }, 100);

            elements.searchInput.disabled = false;
            elements.sortSelect.disabled = false;
            elements.gridViewBtn.disabled = false;
            elements.folderViewBtn.disabled = false;
            elements.comicViewBtn.disabled = false;

            // æ˜¾ç¤ºåŠ è½½æç¤º
            showLoadingTip(`æ­£åœ¨å¤„ç† ${imageFiles.length} å¼ å›¾ç‰‡çš„åŸºæœ¬ä¿¡æ¯...`);

            // ä½¿ç”¨managedSetTimeouté¿å…é˜»å¡UI
            managedSetTimeout(() => {
                // åˆ›å»ºå›¾ç‰‡æ•°æ®å¯¹è±¡ï¼Œä½†ä¸ç«‹å³åˆ›å»ºæ‰€æœ‰URL
                state.images = imageFiles.map((file, index) => {
                    const path = file.webkitRelativePath || file.name;
                    const pathParts = path.split('/');
                    const folder = pathParts.length > 1 ? pathParts.slice(0, -1).join('/') : 'æ ¹ç›®å½•';
                    const fileKey = `${file.name}_${file.size}_${file.lastModified}`;

                    // ä¸åœ¨è¿™é‡Œç«‹å³åˆ›å»ºURLï¼ŒæŒ‰éœ€åˆ›å»º
                    return {
                        name: file.name,
                        path: path,
                        folder: folder,
                        date: new Date(file.lastModified).toISOString().split('T')[0],
                        file: file,
                        url: null, // åˆå§‹ä¸ºnullï¼ŒæŒ‰éœ€åˆ›å»º
                        fileKey: fileKey
                    };
                });

                state.activeFolder = null;
                state.currentPage = 1;

                // æ›´æ–°åŠ è½½æç¤º
                showLoadingTip(`å·²åŠ è½½ ${state.images.length} å¼ å›¾ç‰‡ä¿¡æ¯ï¼Œå‡†å¤‡æ¸²æŸ“...`);

                filterAndSortImages();
                renderImages();

                // è®¾ç½®æ— é™æ»šåŠ¨
                managedSetTimeout(() => {
                    setupInfiniteScroll();
                }, 100);

                hideLoadingTip();

                // æ˜¾ç¤ºå†…å­˜ä½¿ç”¨æç¤º
                managedSetTimeout(() => {
                    if (state.images.length > 200) {
                        console.log(`ğŸ’¡ æç¤º: å·²åŠ è½½ ${state.images.length} å¼ å›¾ç‰‡çš„åŸºæœ¬ä¿¡æ¯`);
                        console.log(`ğŸ“Š å†…å­˜ç­–ç•¥: å›¾ç‰‡URLå°†æŒ‰éœ€åˆ›å»ºï¼Œæœ€å¤šç¼“å­˜ ${state.maxCacheSize} ä¸ª`);
                    }
                }, 1000);
            }, 100);
        }

        // æ˜¾ç¤ºåŠ è½½æç¤º
        function showLoadingTip(message) {
            // å…ˆç§»é™¤å·²å­˜åœ¨çš„åŠ è½½æç¤º
            hideLoadingTip();

            const tip = document.createElement('div');
            tip.id = 'loadingTip';
            tip.className = 'loading-tip';
            tip.textContent = message;
            tip.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: rgba(0, 0, 0, 0.8);
                color: white;
                padding: 15px 25px;
                border-radius: 8px;
                z-index: 2000;
                font-size: 1.1rem;
            `;
            document.body.appendChild(tip);
            console.log('æ˜¾ç¤ºåŠ è½½æç¤º:', message);
        }

        // éšè—åŠ è½½æç¤º
        function hideLoadingTip() {
            const tip = document.getElementById('loadingTip');
            if (tip) {
                tip.remove();
                console.log('éšè—åŠ è½½æç¤º');
            } else {
                console.log('æœªæ‰¾åˆ°åŠ è½½æç¤ºå…ƒç´ ');
            }
        }

        // éªŒè¯æ‰€æœ‰å›¾ç‰‡URLçš„æœ‰æ•ˆæ€§
        function validateAllImageUrls() {
            let validCount = 0;
            let invalidCount = 0;

            state.images.forEach((image, index) => {
                if (image.url) {
                    const testImg = new Image();
                    testImg.onload = () => {
                        validCount++;
                        console.log(`âœ… å›¾ç‰‡ ${index + 1}/${state.images.length} éªŒè¯æˆåŠŸ:`, image.name);

                        if (validCount + invalidCount === state.images.length) {
                            console.log(`ğŸ“Š URLéªŒè¯å®Œæˆ: ${validCount} ä¸ªæˆåŠŸ, ${invalidCount} ä¸ªå¤±è´¥`);
                        }
                    };
                    testImg.onerror = () => {
                        invalidCount++;
                        console.error(`âŒ å›¾ç‰‡ ${index + 1}/${state.images.length} éªŒè¯å¤±è´¥:`, image.name, 'URL:', image.url);

                        // å°è¯•é‡æ–°åˆ›å»ºURL
                        const newUrl = getImageUrl(image.file);
                        if (newUrl && newUrl !== image.url) {
                            console.log(`ğŸ”„ å°è¯•é‡æ–°åˆ›å»ºURL:`, image.name);
                            image.url = newUrl;
                            // é‡æ–°éªŒè¯
                            setTimeout(() => {
                                const retryImg = new Image();
                                retryImg.onload = () => {
                                    validCount++;
                                    invalidCount--;
                                    console.log(`âœ… é‡è¯•æˆåŠŸ:`, image.name);
                                };
                                retryImg.onerror = () => {
                                    console.error(`âŒ é‡è¯•å¤±è´¥:`, image.name);
                                };
                                retryImg.src = newUrl;
                            }, 100);
                        }

                        if (validCount + invalidCount === state.images.length) {
                            console.log(`ğŸ“Š URLéªŒè¯å®Œæˆ: ${validCount} ä¸ªæˆåŠŸ, ${invalidCount} ä¸ªå¤±è´¥`);
                        }
                    };
                    testImg.src = image.url;
                } else {
                    invalidCount++;
                    console.warn(`âš ï¸ å›¾ç‰‡URLä¸ºç©º:`, image.name);
                }
            });
        }

        // è¿›å…¥ç‰¹å®šæ–‡ä»¶å¤¹
        function enterFolder(folderName) {
            // å¯åŠ¨è§†å›¾åˆ‡æ¢ä¿æŠ¤
            viewSwitchProtection.isSwitching = true;
            viewSwitchProtection.startTime = Date.now();
            state.isViewSwitching = true;

            state.activeFolder = folderName;
            state.searchQuery = ''; // æ¸…ç©ºæœç´¢ï¼Œæˆ–è€…ä¿ç•™çœ‹éœ€æ±‚ï¼Œé€šå¸¸è¿›å…¥æ–‡ä»¶å¤¹æƒ³çœ‹æ‰€æœ‰çš„
            elements.searchInput.value = '';
            state.currentPage = 1; // é‡ç½®åˆ†é¡µ

            // å¼ºåˆ¶åˆ‡æ¢åˆ°ç½‘æ ¼è§†å›¾ï¼Œè¿™æ˜¯è¿›å…¥æ–‡ä»¶å¤¹åçš„é»˜è®¤è§†å›¾
            // ä¸è°ƒç”¨switchViewï¼Œé¿å…é¢å¤–çš„çŠ¶æ€é‡ç½®
            state.currentView = 'grid';

            // é‡æ–°è®¡ç®—è¿‡æ»¤
            filterAndSortImages();

            // æ›´æ–°æŒ‰é’®çŠ¶æ€å’Œé¢åŒ…å±‘
            updateBreadcrumb();
            elements.gridViewBtn.classList.remove('active');
            elements.folderViewBtn.classList.remove('active');
            elements.comicViewBtn.classList.remove('active');

            // æ˜¾ç¤º/éšè—è§†å›¾
            elements.masonryView.style.display = 'flex';
            elements.comicView.style.display = 'none';
            elements.folderView.style.display = 'none';

            // é‡æ–°æ¸²æŸ“
            renderImages();

            // æ»šåŠ¨åˆ°é¡µé¢é¡¶éƒ¨
            setTimeout(() => {
                window.scrollTo({
                    top: 0,
                    left: 0,
                    behavior: 'smooth'
                });
            }, 200);

            // é‡ç½®æ— é™æ»šåŠ¨
            setTimeout(() => {
                setupInfiniteScroll();

                // åœ¨ä¿æŠ¤æœŸç»“æŸåé‡ç½®çŠ¶æ€
                setTimeout(() => {
                    state.isViewSwitching = false;
                    viewSwitchProtection.isSwitching = false;
                }, viewSwitchProtection.protectionDuration);
            }, 100);
        }

        // è¿‡æ»¤å’Œæ’åºå›¾ç‰‡
        function filterAndSortImages() {
            let sourceImages = state.images;

            // 1. é¦–å…ˆæŒ‰æ–‡ä»¶å¤¹è¿‡æ»¤ï¼ˆå¦‚æœæ¿€æ´»äº†ç‰¹å®šæ–‡ä»¶å¤¹ï¼‰
            if (state.activeFolder) {
                sourceImages = sourceImages.filter(img => img.folder === state.activeFolder);
            }

            // 2. ç„¶åæŒ‰æœç´¢å…³é”®è¯è¿‡æ»¤
            state.filteredImages = sourceImages.filter(img => 
                img.name.toLowerCase().includes(state.searchQuery.toLowerCase()) ||
                img.path.toLowerCase().includes(state.searchQuery.toLowerCase())
            );
            
            // 3. æ’åº
            switch (state.sortBy) {
                case 'name':
                    state.filteredImages.sort((a, b) => a.name.localeCompare(b.name));
                    break;
                case 'date':
                    state.filteredImages.sort((a, b) => new Date(b.date) - new Date(a.date));
                    break;
                case 'random':
                    for (let i = state.filteredImages.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [state.filteredImages[i], state.filteredImages[j]] = [state.filteredImages[j], state.filteredImages[i]];
                    }
                    break;
            }
        }

        // åˆ‡æ¢è§†å›¾
        function switchView(view) {
            // è®°å½•ä¹‹å‰çš„è§†å›¾ï¼Œç”¨äºçŠ¶æ€è·Ÿè¸ª
            const previousView = state.currentView;

            // å¯åŠ¨è§†å›¾åˆ‡æ¢ä¿æŠ¤
            viewSwitchProtection.isSwitching = true;
            viewSwitchProtection.startTime = Date.now();

            state.isViewSwitching = true;
            state.currentView = view;
            state.currentPage = 1;

            // æ·»åŠ è°ƒè¯•æ—¥å¿—
            console.log('è§†å›¾åˆ‡æ¢:', {
                from: previousView,
                to: view,
                activeFolder: state.activeFolder,
                searchQuery: state.searchQuery,
                imagesLength: state.images.length
            });

            // é‡æ–°è®¡ç®—è¿‡æ»¤çš„é€»è¾‘ï¼š
            // æ–‡ä»¶å¤¹è§†å›¾ä¸éœ€è¦è¿‡æ»¤ï¼Œåº”è¯¥æ˜¾ç¤ºæ‰€æœ‰å›¾ç‰‡çš„åˆ†ç»„
            // å…¶ä»–è§†å›¾éœ€è¦åº”ç”¨å½“å‰çš„è¿‡æ»¤æ¡ä»¶
            if (view === 'folder') {
                console.log('åˆ‡æ¢åˆ°æ–‡ä»¶å¤¹è§†å›¾ï¼Œä¸éœ€è¦è¿‡æ»¤ï¼Œä½¿ç”¨æ‰€æœ‰å›¾ç‰‡æ•°æ®');
                // ä¸éœ€è¦è°ƒç”¨filterAndSortImagesï¼Œè®©renderImagesä½¿ç”¨state.images
            } else {
                console.log('åˆ‡æ¢åˆ°å…¶ä»–è§†å›¾ï¼Œåº”ç”¨å½“å‰è¿‡æ»¤æ¡ä»¶');
                filterAndSortImages();
            }

            // æ›´æ–°é¢åŒ…å±‘
            updateBreadcrumb();

            // æ›´æ–°æŒ‰é’®çŠ¶æ€ï¼šç»Ÿä¸€é€»è¾‘ï¼Œä¸å—activeFolderå½±å“
            elements.gridViewBtn.classList.toggle('active', view === 'grid');
            elements.folderViewBtn.classList.toggle('active', view === 'folder');
            elements.comicViewBtn.classList.toggle('active', view === 'comic');

            // æ˜¾ç¤º/éšè—è§†å›¾
            elements.masonryView.style.display = view === 'grid' ? 'flex' : 'none';
            elements.comicView.style.display = view === 'comic' ? 'block' : 'none';
            elements.folderView.style.display = view === 'folder' ? 'block' : 'none';

            // é‡æ–°æ¸²æŸ“ - ä½¿ç”¨åŒé‡requestAnimationFrameç¡®ä¿DOMå®Œå…¨æ›´æ–°
            requestAnimationFrame(() => {
                renderImages();

                // ç¡®ä¿DOMæ›´æ–°å®Œæˆåå†è®¾ç½®æ— é™æ»šåŠ¨
                requestAnimationFrame(() => {
                    setupInfiniteScroll();

                    // åœ¨ä¿æŠ¤æœŸç»“æŸåé‡ç½®çŠ¶æ€
                    setTimeout(() => {
                        state.isViewSwitching = false;
                        viewSwitchProtection.isSwitching = false;
                        console.log('è§†å›¾åˆ‡æ¢å®Œæˆ:', view);
                    }, viewSwitchProtection.protectionDuration);
                });
            });
        }

        // æ›´æ–°é¢åŒ…å±‘å¯¼èˆª
        function updateBreadcrumb() {
            if (state.activeFolder) {
                elements.breadcrumbBar.classList.add('visible');
                elements.breadcrumbFolder.textContent = state.activeFolder;
                // åœ¨æ–‡ä»¶å¤¹æ¨¡å¼ä¸‹ï¼Œé¡¶éƒ¨è§†å›¾æŒ‰é’®ç¦ç”¨æˆ–è§†è§‰ä¸Šå˜ç°å¯èƒ½æ›´å¥½ï¼Œä½†è¿™é‡Œæˆ‘ä»¬ä¿æŒå¯ç”¨ä½œä¸º"Reset"æ‰‹æ®µ
            } else {
                elements.breadcrumbBar.classList.remove('visible');
            }
        }

        // æ¸²æŸ“å›¾ç‰‡ - ä¼˜åŒ–ç‰ˆæœ¬
        function renderImages() {
            // ä¿å­˜å½“å‰æ»šåŠ¨ä½ç½®
            const scrollPosition = window.scrollY;
            const scrollThreshold = 200; // å¢åŠ é˜ˆå€¼ï¼Œé¿å…è¯¯åˆ¤
            const isNearBottom = (window.innerHeight + window.scrollY) >= document.documentElement.scrollHeight - scrollThreshold;

            // æ–‡ä»¶å¤¹è§†å›¾çš„ç‰¹æ®Šå¤„ç†
            if (state.currentView === 'folder') {
                if (state.images.length === 0) {
                    elements.emptyState.classList.remove('hidden');
                    elements.masonryView.classList.add('hidden');
                    elements.comicView.classList.add('hidden');
                    elements.folderView.classList.add('hidden');
                    elements.imageCount.textContent = '0';
                    return;
                }

                elements.emptyState.classList.add('hidden');
                // æ–‡ä»¶å¤¹è§†å›¾æ˜¾ç¤ºæ‰€æœ‰å›¾ç‰‡æ•°é‡ï¼Œè€Œä¸æ˜¯è¿‡æ»¤åçš„æ•°é‡
                elements.imageCount.textContent = state.images.length;

                requestAnimationFrame(() => {
                    renderFolderView(state.images, scrollPosition, isNearBottom);
                });
                return;
            }

            const visibleImages = state.filteredImages.slice(0, state.currentPage * state.itemsPerPage);

            if (visibleImages.length === 0) {
                elements.emptyState.classList.remove('hidden');
                elements.masonryView.classList.add('hidden');
                elements.comicView.classList.add('hidden');
                elements.folderView.classList.add('hidden');
                elements.imageCount.textContent = '0';
                return;
            }

            elements.emptyState.classList.add('hidden');
            elements.imageCount.textContent = visibleImages.length;

            // ä½¿ç”¨requestAnimationFrameä¼˜åŒ–æ¸²æŸ“æ—¶æœº
            requestAnimationFrame(() => {
                if (state.currentView === 'grid') {
                    renderGridView(visibleImages, scrollPosition, isNearBottom);
                } else if (state.currentView === 'comic') {
                    renderComicView(visibleImages, scrollPosition, isNearBottom);
                } else {
                    // å…œåº•å¤„ç†ï¼šå¦‚æœçŠ¶æ€ä¸åŒ¹é…ï¼Œå¼ºåˆ¶åˆ‡æ¢åˆ°ç½‘æ ¼è§†å›¾
                    console.warn('æ„å¤–çš„è§†å›¾çŠ¶æ€:', state.currentView, 'å¼ºåˆ¶åˆ‡æ¢åˆ°ç½‘æ ¼è§†å›¾');
                    state.currentView = 'grid';
                    renderGridView(visibleImages, scrollPosition, isNearBottom);
                }
            });
        }

        // ä¼˜åŒ–çš„ç½‘æ ¼è§†å›¾æ¸²æŸ“
        function renderGridView(images, scrollPosition, isNearBottom) {
            // ä½¿ç”¨DocumentFragmentæ‰¹é‡æ“ä½œDOM
            const fragment = document.createDocumentFragment();

            // ä¸ºæ¯ä¸ªå›¾ç‰‡åˆ›å»ºå…ƒç´ ï¼Œè¿‡æ»¤æ‰æ— æ•ˆçš„å›¾ç‰‡é¡¹
            images.forEach((image) => {
                const imageItem = createImageItem(image);
                if (imageItem) {
                    fragment.appendChild(imageItem);
                }
            });

            // è®¾ç½®å®¹å™¨ä¸ºå›ºå®šé«˜åº¦ï¼Œé¿å…é¡µé¢é«˜åº¦çªç„¶å˜åŒ–å¯¼è‡´çš„è·³è·ƒ
            const currentHeight = elements.masonryView.scrollHeight;
            if (currentHeight > 0) {
                elements.masonryView.style.minHeight = currentHeight + 'px';
            }

            // ä¸€æ¬¡æ€§æ›´æ–°DOM
            elements.masonryView.innerHTML = '';
            elements.masonryView.appendChild(fragment);

            elements.masonryView.classList.remove('hidden');
            elements.comicView.classList.add('hidden');
            elements.folderView.classList.add('hidden');

            // æ”¹è¿›çš„æ»šåŠ¨ä½ç½®æ¢å¤é€»è¾‘
            requestAnimationFrame(() => {
                // ç§»é™¤ä¸´æ—¶è®¾ç½®çš„å›ºå®šé«˜åº¦
                elements.masonryView.style.minHeight = '';

                // è·å–æ–°çš„é¡µé¢é«˜åº¦
                const newPageHeight = document.documentElement.scrollHeight;

                // æ™ºèƒ½æ»šåŠ¨ä½ç½®æ¢å¤ï¼š
                // 1. å¦‚æœä¸åœ¨åº•éƒ¨ä¸”æ–°é¡µé¢è¶³å¤Ÿé«˜ï¼Œæ¢å¤åŸä½ç½®
                // 2. å¦‚æœæ–°é¡µé¢é«˜åº¦ä¸è¶³ä»¥åˆ°è¾¾åŸä½ç½®ï¼Œæ»šåŠ¨åˆ°åˆç†ä½ç½®
                if (!isNearBottom) {
                    const targetScrollPosition = Math.min(scrollPosition, newPageHeight - window.innerHeight - 100);
                    if (targetScrollPosition > 0) {
                        window.scrollTo({
                            top: targetScrollPosition,
                            left: 0,
                            behavior: 'instant' // ä½¿ç”¨instanté¿å…åŠ¨ç”»è·³è·ƒ
                        });
                        console.log('ç½‘æ ¼è§†å›¾æ»šåŠ¨ä½ç½®å·²æ¢å¤:', targetScrollPosition);
                    }
                }
            });
        }

        // åˆ›å»ºå›¾ç‰‡é¡¹ï¼ˆå¸¦å ä½ç¬¦ï¼‰
        function createImageItem(image, viewType = 'grid') {
            const item = document.createElement('div');
            item.className = 'image-item';
            item.dataset.fileKey = getImageKey(image.file);

            // åˆ›å»ºå ä½ç¬¦
            const placeholder = document.createElement('div');
            placeholder.className = 'image-placeholder';
            placeholder.textContent = 'åŠ è½½ä¸­...';
            item.appendChild(placeholder);

            // åˆ›å»ºå›¾ç‰‡å…ƒç´ 
            const img = document.createElement('img');
            img.dataset.fileKey = getImageKey(image.file);
            img.dataset.lazy = "true";
            img.alt = image.name;

            // å›¾ç‰‡åŠ è½½å®Œæˆåç§»é™¤å ä½ç¬¦
            img.onload = function() {
                placeholder.remove();
                img.classList.add('loaded');
            };

            // å›¾ç‰‡åŠ è½½å¤±è´¥æ—¶é‡è¯•
            img.onerror = function() {
                setTimeout(() => {
                    const key = img.dataset.fileKey;
                    if (key && state.urlCache.has(key)) {
                        img.src = state.urlCache.get(key);
                    }
                }, 1000);
            };

            item.appendChild(img);

            // æ·»åŠ å›¾ç‰‡ä¿¡æ¯
            const info = document.createElement('div');
            info.className = 'image-info';
            info.innerHTML = `
                <div class="image-name">${image.name}</div>
                <div class="image-path">${image.path}</div>
            `;
            item.appendChild(info);

            // ç‚¹å‡»å›¾ç‰‡æ‰“å¼€å…¨å±
            img.addEventListener('click', (e) => {
                e.stopPropagation();
                const actualIndex = state.filteredImages.findIndex(item => item.fileKey === getImageKey(image.file));
                if (actualIndex !== -1) {
                    openFullscreen(actualIndex);
                }
            });

            // å ä½ç¬¦ä¹Ÿå¯ä»¥ç‚¹å‡»
            placeholder.addEventListener('click', (e) => {
                e.stopPropagation();
                const actualIndex = state.filteredImages.findIndex(item => item.fileKey === getImageKey(image.file));
                if (actualIndex !== -1) {
                    openFullscreen(actualIndex);
                }
            });

            // è®¾ç½®æ‡’åŠ è½½
            setupLazyLoadForImage(img, placeholder, image);

            return item;
        }

        // è®¾ç½®å•ä¸ªå›¾ç‰‡çš„æ‡’åŠ è½½
        function setupLazyLoadForImage(img, placeholder, imageData) {
            // ä½¿ç”¨Intersection Observerè¿›è¡Œæ‡’åŠ è½½
            const imageObserver = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const targetImg = entry.target;

                        // å¦‚æœå·²ç»åŠ è½½è¿‡ï¼Œè·³è¿‡
                        if (targetImg.src && targetImg.src !== window.location.href) {
                            imageObserver.unobserve(targetImg);
                            // æ¸…ç†Observerå¼•ç”¨
                            delete targetImg._lazyObserver;
                            return;
                        }

                        // æ£€æŸ¥ç¼“å­˜ä¸­æ˜¯å¦å·²æœ‰URL
                        let imageUrl = imageData.url;
                        if (!imageUrl) {
                            // æŒ‰éœ€åˆ›å»ºURL
                            imageUrl = getImageUrl(imageData.file);
                            if (imageUrl) {
                                imageData.url = imageUrl; // æ›´æ–°ç¼“å­˜
                            }
                        }

                        if (imageUrl) {
                            // æ›´æ–°å ä½ç¬¦çŠ¶æ€
                            placeholder.innerHTML = `
                                <div style="text-align: center;">
                                    <div style="font-size: 1.5rem;">â³</div>
                                    <div>åŠ è½½ä¸­...</div>
                                </div>
                            `;

                            // è®¾ç½®å›¾ç‰‡æº
                            targetImg.src = imageUrl;
                        } else {
                            placeholder.innerHTML = `
                                <div style="text-align: center; color: #ff6b6b;">
                                    <div style="font-size: 1.5rem;">âŒ</div>
                                    <div>URLåˆ›å»ºå¤±è´¥</div>
                                </div>
                            `;
                        }

                        // ç§»é™¤è§‚å¯Ÿå¹¶æ¸…ç†å¼•ç”¨
                        imageObserver.unobserve(targetImg);
                        delete targetImg._lazyObserver;
                    }
                });
            }, {
                root: null,
                rootMargin: '100px', // æå‰100pxå¼€å§‹åŠ è½½
                threshold: 0.1
            });

            // ä¿å­˜Observerå¼•ç”¨ä»¥ä¾¿åç»­æ¸…ç†
            img._lazyObserver = imageObserver;
            img.dataset.observer = 'true';
            imageObserver.observe(img);
        }
    
        // ä¼˜åŒ–çš„æ¡æ¼«è§†å›¾æ¸²æŸ“
        function renderComicView(images, scrollPosition, isNearBottom) {
            const fragment = document.createDocumentFragment();

            // ä¸ºæ¯ä¸ªå›¾ç‰‡åˆ›å»ºå…ƒç´ ï¼Œè¿‡æ»¤æ‰æ— æ•ˆçš„å›¾ç‰‡é¡¹
            images.forEach((image) => {
                const imageItem = createImageItem(image, 'comic');
                if (imageItem) {
                    fragment.appendChild(imageItem);
                }
            });

            // è®¾ç½®å®¹å™¨ä¸ºå›ºå®šé«˜åº¦ï¼Œé¿å…é¡µé¢é«˜åº¦çªç„¶å˜åŒ–å¯¼è‡´çš„è·³è·ƒ
            const currentHeight = elements.comicView.scrollHeight;
            if (currentHeight > 0) {
                elements.comicView.style.minHeight = currentHeight + 'px';
            }

            elements.comicView.innerHTML = '';
            elements.comicView.appendChild(fragment);

            elements.comicView.classList.remove('hidden');
            elements.masonryView.classList.add('hidden');
            elements.folderView.classList.add('hidden');

            // æ”¹è¿›çš„æ»šåŠ¨ä½ç½®æ¢å¤é€»è¾‘
            requestAnimationFrame(() => {
                // ç§»é™¤ä¸´æ—¶è®¾ç½®çš„å›ºå®šé«˜åº¦
                elements.comicView.style.minHeight = '';

                // è·å–æ–°çš„é¡µé¢é«˜åº¦
                const newPageHeight = document.documentElement.scrollHeight;

                // æ™ºèƒ½æ»šåŠ¨ä½ç½®æ¢å¤
                if (!isNearBottom) {
                    const targetScrollPosition = Math.min(scrollPosition, newPageHeight - window.innerHeight - 100);
                    if (targetScrollPosition > 0) {
                        window.scrollTo({
                            top: targetScrollPosition,
                            left: 0,
                            behavior: 'instant' // ä½¿ç”¨instanté¿å…åŠ¨ç”»è·³è·ƒ
                        });
                        console.log('æ¡æ¼«è§†å›¾æ»šåŠ¨ä½ç½®å·²æ¢å¤:', targetScrollPosition);
                    }
                }
            });
        }

        // ä¼˜åŒ–çš„æ–‡ä»¶å¤¹è§†å›¾æ¸²æŸ“
        function renderFolderView(images, scrollPosition, isNearBottom) {
            console.log('renderFolderViewè¢«è°ƒç”¨ï¼Œä¼ å…¥å›¾ç‰‡æ•°é‡:', images.length);

            // ä¼˜åŒ–ç¼“å­˜é”®ï¼šä½¿ç”¨å›¾ç‰‡è·¯å¾„å’Œå¤§å°ç»„åˆä½œä¸ºå“ˆå¸Œ
            const cacheKey = images.slice(0, 10).map(img => img.path + img.file.size).join('|') + '_' + images.length;

            let folders;
            if (state.folderCache.has(cacheKey)) {
                folders = state.folderCache.get(cacheKey);
                console.log('ä½¿ç”¨ä¼˜åŒ–çš„ç¼“å­˜æ•°æ®');
            } else {
                folders = groupImagesByFolder(images);
                state.folderCache.set(cacheKey, folders);
                // é™åˆ¶ç¼“å­˜å¤§å°ï¼Œé¿å…å†…å­˜æ³„æ¼
                if (state.folderCache.size > 5) {
                    const firstKey = state.folderCache.keys().next().value;
                    state.folderCache.delete(firstKey);
                }
                console.log('é‡æ–°è®¡ç®—æ–‡ä»¶å¤¹æ•°æ®ï¼Œæ–‡ä»¶å¤¹æ•°é‡:', Object.keys(folders).length);
            }

            // æ¸…ç†æ—§çš„Observer
            cleanupFolderObservers();

            // ä½¿ç”¨DocumentFragmentä¼˜åŒ–DOMæ“ä½œ
            const fragment = document.createDocumentFragment();
            state.activeFolderObservers = []; // è·Ÿè¸ªå½“å‰Observer

            // æ˜¾ç¤ºæ‰€æœ‰æ–‡ä»¶å¤¹ï¼Œä¸é™åˆ¶æ•°é‡
            const folderNames = Object.keys(folders);
            console.log('å°†è¦æ¸²æŸ“æ‰€æœ‰æ–‡ä»¶å¤¹:', folderNames);

            folderNames.forEach(folderName => {
                const folderItem = createFolderItemOptimized(folders[folderName], folderName);
                fragment.appendChild(folderItem);
            });

            // ä¸€æ¬¡æ€§æ›´æ–°DOM
            elements.folderView.innerHTML = '';
            elements.folderView.appendChild(fragment);

            // ç¡®ä¿æ­£ç¡®çš„æ˜¾ç¤ºçŠ¶æ€
            elements.folderView.classList.remove('hidden');
            elements.folderView.style.display = 'block';
            elements.masonryView.classList.add('hidden');
            elements.comicView.classList.add('hidden');

            // æ–‡ä»¶å¤¹è§†å›¾ä¹Ÿéœ€è¦æ¢å¤æ»šåŠ¨ä½ç½®
            requestAnimationFrame(() => {
                // è·å–æ–°çš„é¡µé¢é«˜åº¦
                const newPageHeight = document.documentElement.scrollHeight;

                // åªæœ‰åœ¨ä»¥ä¸‹æƒ…å†µä¸‹æ‰æ¢å¤æ»šåŠ¨ä½ç½®ï¼š
                // 1. ä¸åœ¨åº•éƒ¨ï¼ˆæœ‰è¶³å¤Ÿçš„ä¸‹æ–¹ç©ºé—´ï¼‰
                // 2. æ–°é¡µé¢é«˜åº¦å¤§äºåŸæ¥çš„æ»šåŠ¨ä½ç½®ï¼ˆé¿å…æ— æ•ˆæ»šåŠ¨ï¼‰
                if (!isNearBottom && newPageHeight > scrollPosition) {
                    window.scrollTo({
                        top: scrollPosition,
                        left: 0,
                        behavior: 'instant' // ä½¿ç”¨instanté¿å…åŠ¨ç”»è·³è·ƒ
                    });
                    console.log('æ–‡ä»¶å¤¹è§†å›¾æ»šåŠ¨ä½ç½®å·²æ¢å¤:', scrollPosition);
                }
            });

            console.log('æ–‡ä»¶å¤¹è§†å›¾æ¸²æŸ“å®Œæˆ');
        }

        // æ¸…ç†æ–‡ä»¶å¤¹Observer
        function cleanupFolderObservers() {
            if (state.activeFolderObservers) {
                state.activeFolderObservers.forEach(observer => {
                    if (observer) observer.disconnect();
                });
                state.activeFolderObservers = [];
            }
        }

        // æŒ‰æ–‡ä»¶å¤¹åˆ†ç»„å›¾ç‰‡
        function groupImagesByFolder(images) {
            const folders = {};
            images.forEach(image => {
                const folderPath = image.folder;
                if (!folders[folderPath]) {
                    folders[folderPath] = [];
                }
                folders[folderPath].push(image);
            });
            return folders;
        }

        // ä¼˜åŒ–çš„æ–‡ä»¶å¤¹é¡¹åˆ›å»ºå‡½æ•°
        function createFolderItemOptimized(folderImages, folderName) {
            const folderItem = document.createElement('div');
            folderItem.className = 'folder-item';

            // åˆ›å»ºæ–‡ä»¶å¤¹å¤´éƒ¨
            const header = document.createElement('div');
            header.className = 'folder-header';

            const folderNameDiv = document.createElement('div');
            folderNameDiv.className = 'folder-name';

            const folderIcon = document.createElement('span');
            folderIcon.className = 'folder-icon';
            folderIcon.textContent = 'ğŸ“‚';

            const folderNameText = document.createElement('span');
            folderNameText.textContent = folderName;

            const folderCount = document.createElement('div');
            folderCount.className = 'folder-count';
            folderCount.textContent = `${folderImages.length} å¼ å›¾ç‰‡`;

            folderNameDiv.appendChild(folderIcon);
            folderNameDiv.appendChild(folderNameText);
            header.appendChild(folderNameDiv);
            header.appendChild(folderCount);

            // åˆ›å»ºå›¾ç‰‡é¢„è§ˆå®¹å™¨
            const imagesContainer = document.createElement('div');
            imagesContainer.className = 'folder-images';

            // å‡å°‘é¢„è§ˆå›¾ç‰‡æ•°é‡åˆ°3å¼ ï¼Œæå‡æ€§èƒ½
            const previewImages = folderImages.slice(0, 3);
            const moreCount = folderImages.length - previewImages.length;

            previewImages.forEach((image, index) => {
                const folderImage = createFolderImageOptimized(image, folderName);
                imagesContainer.appendChild(folderImage);
            });

            // å¦‚æœè¿˜æœ‰æ›´å¤šå›¾ç‰‡ï¼Œæ·»åŠ æç¤º
            if (moreCount > 0) {
                const moreInfo = document.createElement('div');
                moreInfo.style.cssText = `
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    color: #666;
                    font-size: 0.9rem;
                    aspect-ratio: 1;
                `;
                moreInfo.textContent = `+${moreCount}`;
                imagesContainer.appendChild(moreInfo);
            }

            // ç»„è£…æ–‡ä»¶å¤¹é¡¹
            folderItem.appendChild(header);
            folderItem.appendChild(imagesContainer);

            // ç»‘å®šå¤´éƒ¨ç‚¹å‡»äº‹ä»¶ - ä½¿ç”¨äº‹ä»¶å§”æ‰˜ä¼˜åŒ–
            header.addEventListener('click', () => {
                enterFolder(folderName);
            });

            return folderItem;
        }

        // ä¼˜åŒ–çš„æ–‡ä»¶å¤¹å›¾ç‰‡åˆ›å»ºå‡½æ•° - ä½¿ç”¨å•ä¸ªObserver
        function createFolderImageOptimized(image, folderName) {
            const folderImage = document.createElement('div');
            folderImage.className = 'folder-image';

            // æ·»åŠ å ä½ç¬¦
            const placeholder = document.createElement('div');
            placeholder.className = 'image-placeholder';
            placeholder.textContent = 'åŠ è½½ä¸­...';
            folderImage.appendChild(placeholder);

            // æ·»åŠ å›¾ç‰‡
            const img = document.createElement('img');
            img.dataset.fileKey = getImageKey(image.file);
            img.dataset.lazy = "true";
            img.alt = image.name;

            img.onload = function() {
                placeholder.remove();
            };

            img.onerror = function() {
                placeholder.innerHTML = 'âŒ';
            };

            folderImage.appendChild(img);

            // ä½¿ç”¨ç»Ÿä¸€çš„Observerè¿›è¡Œæ‡’åŠ è½½
            setupFolderImageLazyLoad(img, placeholder, image);

            return folderImage;
        }

        // ç»Ÿä¸€çš„æ–‡ä»¶å¤¹å›¾ç‰‡æ‡’åŠ è½½Observer
        function setupFolderImageLazyLoad(img, placeholder, imageData) {
            // åˆ›å»ºå•ä¸ªå…¨å±€Observerç”¨äºæ‰€æœ‰æ–‡ä»¶å¤¹å›¾ç‰‡
            if (!state.folderImageObserver) {
                state.folderImageObserver = new IntersectionObserver((entries) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            const targetImg = entry.target;
                            const targetPlaceholder = targetImg.previousSibling;

                            // æ£€æŸ¥ç¼“å­˜ä¸­æ˜¯å¦å·²æœ‰URL
                            let imageUrl = imageData.url;
                            if (!imageUrl) {
                                imageUrl = getImageUrl(imageData.file);
                                if (imageUrl) {
                                    imageData.url = imageUrl;
                                }
                            }

                            if (imageUrl) {
                                targetImg.src = imageUrl;
                                targetPlaceholder.remove();
                            } else {
                                targetPlaceholder.innerHTML = 'âŒ';
                            }

                            // åœæ­¢è§‚å¯Ÿæ­¤å›¾ç‰‡
                            state.folderImageObserver.unobserve(targetImg);
                        }
                    });
                }, {
                    root: null,
                    rootMargin: '50px', // å‡å°‘é¢„åŠ è½½è·ç¦»
                    threshold: 0.1
                });

                // ä¿å­˜Observerä»¥ä¾¿æ¸…ç†
                state.activeFolderObservers.push(state.folderImageObserver);
            }

            // è§‚å¯Ÿå½“å‰å›¾ç‰‡
            state.folderImageObserver.observe(img);
        }

        // åˆ›å»ºæ–‡ä»¶å¤¹é¡¹å…ƒç´ 
        function createFolderItem(folderImages, folderName) {
            const folderItem = document.createElement('div');
            folderItem.className = 'folder-item';

            // åˆ›å»ºæ–‡ä»¶å¤¹å¤´éƒ¨
            const header = document.createElement('div');
            header.className = 'folder-header';

            const folderNameDiv = document.createElement('div');
            folderNameDiv.className = 'folder-name';

            const folderIcon = document.createElement('span');
            folderIcon.className = 'folder-icon';
            folderIcon.textContent = 'ğŸ“‚';

            const folderNameText = document.createElement('span');
            folderNameText.textContent = folderName;

            const folderCount = document.createElement('div');
            folderCount.className = 'folder-count';
            folderCount.textContent = `${folderImages.length} å¼ å›¾ç‰‡`;

            folderNameDiv.appendChild(folderIcon);
            folderNameDiv.appendChild(folderNameText);
            header.appendChild(folderNameDiv);
            header.appendChild(folderCount);

            // åˆ›å»ºå›¾ç‰‡é¢„è§ˆå®¹å™¨
            const imagesContainer = document.createElement('div');
            imagesContainer.className = 'folder-images';

            // åªåŠ è½½å‰5å¼ å›¾ç‰‡ï¼ˆå‡å°‘é¢„è§ˆæ•°é‡æå‡æ€§èƒ½ï¼‰
            const previewImages = folderImages.slice(0, 5);
            const moreCount = folderImages.length - previewImages.length;

            previewImages.forEach((image, index) => {
                const folderImage = createFolderImage(image, folderName);
                imagesContainer.appendChild(folderImage);
            });

            // å¦‚æœè¿˜æœ‰æ›´å¤šå›¾ç‰‡ï¼Œæ·»åŠ æç¤º
            if (moreCount > 0) {
                const moreInfo = document.createElement('div');
                moreInfo.style.cssText = `
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    color: #666;
                    font-size: 0.9rem;
                    aspect-ratio: 1;
                `;
                moreInfo.textContent = `+${moreCount}`;
                imagesContainer.appendChild(moreInfo);
            }

            // ç»„è£…æ–‡ä»¶å¤¹é¡¹
            folderItem.appendChild(header);
            folderItem.appendChild(imagesContainer);

            // ç»‘å®šå¤´éƒ¨ç‚¹å‡»äº‹ä»¶
            header.addEventListener('click', () => {
                enterFolder(folderName);
            });

            return folderItem;
        }

        // åˆ›å»ºæ–‡ä»¶å¤¹å›¾ç‰‡é¢„è§ˆ - æ‡’åŠ è½½ç‰ˆæœ¬
        function createFolderImage(image, folderName) {
            const folderImage = document.createElement('div');
            folderImage.className = 'folder-image';

            // æ·»åŠ å ä½ç¬¦
            const placeholder = document.createElement('div');
            placeholder.className = 'image-placeholder';
            placeholder.textContent = 'åŠ è½½ä¸­...';
            folderImage.appendChild(placeholder);

            // æ·»åŠ å›¾ç‰‡
            const img = document.createElement('img');
            img.dataset.fileKey = getImageKey(image.file);
            img.dataset.lazy = "true";
            img.alt = image.name;

            img.onload = function() {
                placeholder.remove();
            };

            img.onerror = function() {
                setTimeout(() => {
                    const key = img.dataset.fileKey;
                    if (key && state.urlCache.has(key)) {
                        img.src = state.urlCache.get(key);
                    }
                }, 1000);
            };

            img.addEventListener('click', (e) => {
                e.stopPropagation();
                const globalIndex = state.filteredImages.findIndex(item => item.fileKey === getImageKey(image.file));
                if (globalIndex !== -1) {
                    openFullscreen(globalIndex);
                }
            });

            folderImage.appendChild(img);

            // è®¾ç½®æ‡’åŠ è½½
            setupLazyLoadForImage(img, placeholder, image);

            return folderImage;
        }

        function openFullscreen(index) {
            state.fullscreenIndex = index;
            const image = state.filteredImages[index];
            resetZoom();
            document.body.classList.add('fullscreen-active');

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            elements.fullscreenImage.style.opacity = "0.5";

            // è®¾ç½®å›¾ç‰‡ä¿¡æ¯
            elements.fullscreenCaption.textContent = `${image.name} (${index + 1}/${state.filteredImages.length})`;

            // åŠ è½½å›¾ç‰‡
            const key = getImageKey(image.file);
            elements.fullscreenImage.dataset.fileKey = key;

            if (state.urlCache.has(key)) {
                elements.fullscreenImage.src = state.urlCache.get(key);
                state.urlCreationTime.set(key, Date.now());
            } else {
                const url = URL.createObjectURL(image.file);
                elements.fullscreenImage.src = url;
                state.urlCache.set(key, url);
                state.urlCreationTime.set(key, Date.now());
            }

            // å›¾ç‰‡åŠ è½½å®Œæˆ
            elements.fullscreenImage.onload = function() {
                elements.fullscreenImage.style.opacity = "1";
                resetZoom();
            };

            // å›¾ç‰‡åŠ è½½å¤±è´¥é‡è¯•
            elements.fullscreenImage.onerror = function() {
                setTimeout(() => {
                    if (state.urlCache.has(key)) {
                        elements.fullscreenImage.src = state.urlCache.get(key);
                    } else {
                        const url = URL.createObjectURL(image.file);
                        elements.fullscreenImage.src = url;
                        state.urlCache.set(key, url);
                        state.urlCreationTime.set(key, Date.now());
                    }
                }, 1000);
            };

            // æ˜¾ç¤ºå…¨å±
            elements.fullscreenOverlay.style.display = 'flex';

            updateNavButtons();
        }

        function closeFullscreen() {
            document.body.classList.remove('fullscreen-active');
            elements.fullscreenOverlay.style.display = 'none';
            resetZoom();
        }

        function showPrevImage() {
            if (state.fullscreenIndex > 0) {
                state.fullscreenIndex--;
                switchImage();
            }
        }

        function showNextImage() {
            if (state.fullscreenIndex < state.filteredImages.length - 1) {
                state.fullscreenIndex++;
                switchImage();
            }
        }

        function switchImage() {
            const image = state.filteredImages[state.fullscreenIndex];

            // æŒ‰éœ€åˆ›å»ºæˆ–è·å–å›¾ç‰‡URL
            let imageUrl = image.url;
            if (!imageUrl) {
                imageUrl = getImageUrl(image.file);
                if (imageUrl) {
                    image.url = imageUrl; // æ›´æ–°ç¼“å­˜
                }
            }

            if (imageUrl) {
                elements.fullscreenImage.src = imageUrl;
                elements.fullscreenCaption.textContent = `${image.name} (${image.path})`;
            } else {
                elements.fullscreenImage.src = '';
                elements.fullscreenCaption.textContent = `${image.name} (åŠ è½½å¤±è´¥)`;
            }

            updateNavButtons();
            resetZoom();
        }

        function updateNavButtons() {
            elements.prevBtn.style.display = state.fullscreenIndex > 0 ? 'flex' : 'none';
            elements.nextBtn.style.display = state.fullscreenIndex < state.filteredImages.length - 1 ? 'flex' : 'none';
        }

        function isScrolledToBottom() {
            return window.innerHeight + window.scrollY >= document.documentElement.scrollHeight - 100;
        }

        // è®¾ç½®æ— é™æ»šåŠ¨ç›‘å¬å™¨ - ä¿®å¤ç‰ˆæœ¬
        function setupInfiniteScroll() {
            // å…ˆç§»é™¤æ—§çš„è§¦å‘å™¨
            const oldTrigger = document.getElementById('loadTrigger');
            if (oldTrigger) {
                oldTrigger.remove();
            }

            // æ–­å¼€æ—§çš„è§‚å¯Ÿå™¨
            if (state.infiniteScrollObserver) {
                state.infiniteScrollObserver.disconnect();
            }

            // æ–‡ä»¶å¤¹è§†å›¾ä¸æ”¯æŒæ— é™æ»šåŠ¨ï¼Œå› ä¸ºå®ƒä¸åˆ†é¡µ
            if (state.currentView === 'folder' && !state.activeFolder) {
                return; // æ–‡ä»¶å¤¹è§†å›¾ä¸éœ€è¦æ— é™æ»šåŠ¨
            }

            // æ£€æŸ¥æ˜¯å¦è¿˜æœ‰æ›´å¤šå†…å®¹
            const hasMoreContent = state.currentPage * state.itemsPerPage < state.filteredImages.length;

            // å¦‚æœæ²¡æœ‰æ›´å¤šå†…å®¹ï¼Œç›´æ¥è¿”å›
            if (!hasMoreContent) {
                return;
            }

            // åˆ›å»ºåŠ è½½æŒ‡ç¤ºå™¨
            const loadTrigger = document.createElement('div');
            loadTrigger.id = 'loadTrigger';
            loadTrigger.style.cssText = `
                height: 100px;
                min-height: 100px;
                display: flex;
                align-items: center;
                justify-content: center;
                color: #666;
                font-size: 0.9rem;
                pointer-events: none;
                width: 100%;
                margin-top: 20px;
                clear: both;
            `;
            loadTrigger.innerHTML = '<span>æ»šåŠ¨æˆ–ç‚¹å‡»åŠ è½½æ›´å¤š...</span>';

            // æ ¹æ®å½“å‰è§†å›¾é€‰æ‹©åˆé€‚çš„å®¹å™¨
            let container;
            if (state.currentView === 'grid') {
                container = elements.masonryView;
            } else if (state.currentView === 'comic') {
                container = elements.comicView;
            } else {
                // åœ¨activeFolderæ¨¡å¼ä¸‹ï¼Œä½¿ç”¨ç½‘æ ¼è§†å›¾å®¹å™¨
                container = elements.masonryView;
            }

            if (container && container.style.display !== 'none') {
                container.appendChild(loadTrigger);
            } else {
                document.body.appendChild(loadTrigger);
            }

            // ç§»é™¤è‡ªåŠ¨æ»šåŠ¨åˆ°è§¦å‘å™¨çš„é€»è¾‘ï¼Œé¿å…æ„å¤–æ»šåŠ¨
            // setTimeout(() => {
            //     if (!isVisible(loadTrigger)) {
            //         // å¦‚æœè§¦å‘å™¨ä¸å¯è§ï¼Œæ»šåŠ¨åˆ°è§¦å‘å™¨ä½ç½®
            //         loadTrigger.scrollIntoView({ behavior: 'smooth', block: 'end' });
            //     }
            // }, 100);

            // ä½¿ç”¨Intersection Observerç›‘å¬æ»šåŠ¨åˆ°åº•éƒ¨
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    // åŠ¨æ€æ£€æŸ¥æ˜¯å¦è¿˜æœ‰æ›´å¤šå†…å®¹ï¼Œé¿å…é—­åŒ…é—®é¢˜
                    const hasMore = state.currentPage * state.itemsPerPage < state.filteredImages.length;

                    if (entry.isIntersecting && !state.isLoading && hasMore) {
                        // æ£€æŸ¥æ˜¯å¦åœ¨ä¿æŠ¤æœŸå†…
                        const now = Date.now();
                        const isInProtectionPeriod = viewSwitchProtection.isSwitching &&
                            (now - viewSwitchProtection.startTime) < viewSwitchProtection.protectionDuration;

                        if (!isInProtectionPeriod) {
                            loadMoreImagesOptimized();
                        } else {
                            console.log('åœ¨è§†å›¾åˆ‡æ¢ä¿æŠ¤æœŸå†…ï¼Œè·³è¿‡Intersection Observerè§¦å‘çš„è‡ªåŠ¨åŠ è½½');
                        }
                    }
                });
            }, {
                root: null,
                rootMargin: '100px', // é¢„åŠ è½½è·ç¦»
                threshold: 0.01 // é™ä½é˜ˆå€¼ï¼Œæ›´å®¹æ˜“è§¦å‘
            });

            // è§‚å¯ŸåŠ è½½è§¦å‘å™¨
            observer.observe(loadTrigger);

            // æ¸…ç†å‡½æ•°
            state.infiniteScrollObserver = observer;

            // æ·»åŠ ç‚¹å‡»åŠ è½½åŠŸèƒ½ä½œä¸ºå¤‡é€‰æ–¹æ¡ˆ
            loadTrigger.style.cursor = 'pointer';
            loadTrigger.style.pointerEvents = 'auto';
            loadTrigger.addEventListener('click', () => {
                // åŠ¨æ€æ£€æŸ¥æ˜¯å¦è¿˜æœ‰æ›´å¤šå†…å®¹
                const hasMore = state.currentPage * state.itemsPerPage < state.filteredImages.length;
                if (!state.isLoading && hasMore) {
                    loadMoreImagesOptimized();
                }
            });

            // æ£€æŸ¥æ˜¯å¦éœ€è¦ç«‹å³åŠ è½½æ›´å¤šå†…å®¹
            // ä½¿ç”¨æ›´å¼ºçš„ä¿æŠ¤æœºåˆ¶é¿å…åœ¨è§†å›¾åˆ‡æ¢æ—¶è‡ªåŠ¨è§¦å‘
            managedSetTimeout(() => {
                const now = Date.now();
                const isInProtectionPeriod = viewSwitchProtection.isSwitching &&
                    (now - viewSwitchProtection.startTime) < viewSwitchProtection.protectionDuration;

                // åŠ¨æ€æ£€æŸ¥æ˜¯å¦è¿˜æœ‰æ›´å¤šå†…å®¹
                const hasMore = state.currentPage * state.itemsPerPage < state.filteredImages.length;
                if (hasMore && !state.isLoading && !state.isViewSwitching && !isInProtectionPeriod) {
                    const pageHeight = document.documentElement.scrollHeight;
                    const viewportHeight = window.innerHeight;
                    const isPageScrollable = pageHeight > viewportHeight + 50;

                    // åªæœ‰åœ¨é¡µé¢å†…å®¹ç¡®å®æ˜æ˜¾ä¸è¶³æ—¶æ‰è‡ªåŠ¨åŠ è½½
                    if (!isPageScrollable && pageHeight < viewportHeight * 0.4) {
                        console.log('é¡µé¢å†…å®¹æ˜æ˜¾ä¸è¶³ï¼Œè‡ªåŠ¨åŠ è½½æ›´å¤š...');
                        loadMoreImagesOptimized();
                    }
                } else if (isInProtectionPeriod) {
                    console.log('åœ¨è§†å›¾åˆ‡æ¢ä¿æŠ¤æœŸå†…ï¼Œè·³è¿‡è‡ªåŠ¨åŠ è½½');
                }
            }, 800);
        }

        // ä¼˜åŒ–çš„åŠ è½½æ›´å¤šå›¾ç‰‡
        function loadMoreImagesOptimized() {
            if (state.currentPage * state.itemsPerPage >= state.filteredImages.length) {
                // ç§»é™¤åŠ è½½è§¦å‘å™¨ï¼Œå› ä¸ºæ²¡æœ‰æ›´å¤šå†…å®¹äº†
                const loadTrigger = document.getElementById('loadTrigger');
                if (loadTrigger) {
                    loadTrigger.remove();
                }
                return;
            }

            // é˜²æ­¢é‡å¤åŠ è½½
            if (state.isLoading) return;

            state.isLoading = true;
            elements.loadingIndicator.classList.remove('hidden');

            // ä¸´æ—¶éšè—è§¦å‘å™¨ï¼Œé¿å…é‡å¤ç‚¹å‡»
            const loadTrigger = document.getElementById('loadTrigger');
            if (loadTrigger) {
                loadTrigger.innerHTML = '<span>æ­£åœ¨åŠ è½½...</span>';
                loadTrigger.style.pointerEvents = 'none';
            }

            console.log('å¼€å§‹åŠ è½½æ›´å¤šå›¾ç‰‡ï¼Œå½“å‰é¡µ:', state.currentPage);

            // ä¿å­˜å½“å‰æ»šåŠ¨ä½ç½®ï¼Œé¿å…DOMæ›´æ–°å¯¼è‡´çš„è·³è·ƒ
            const currentScrollPosition = window.scrollY;
            const scrollThreshold = 200;
            const isNearBottom = (window.innerHeight + window.scrollY) >= document.documentElement.scrollHeight - scrollThreshold;

            // ä½¿ç”¨requestAnimationFrameä¼˜åŒ–æ€§èƒ½
            requestAnimationFrame(() => {
                state.currentPage++;

                // ç›´æ¥è°ƒç”¨å…·ä½“è§†å›¾çš„æ¸²æŸ“å‡½æ•°ï¼Œé¿å…renderImagesçš„æ»šåŠ¨ä½ç½®ä¿å­˜å¹²æ‰°
                const visibleImages = state.filteredImages.slice(0, state.currentPage * state.itemsPerPage);

                if (state.currentView === 'grid') {
                    renderGridViewWithScrollFix(visibleImages, currentScrollPosition, isNearBottom);
                } else if (state.currentView === 'comic') {
                    renderComicViewWithScrollFix(visibleImages, currentScrollPosition, isNearBottom);
                }

                elements.loadingIndicator.classList.add('hidden');
                state.isLoading = false;

                // æ£€æŸ¥æ˜¯å¦è¿˜æœ‰æ›´å¤šå†…å®¹
                const hasMore = state.currentPage * state.itemsPerPage < state.filteredImages.length;

                if (!hasMore) {
                    // æ²¡æœ‰æ›´å¤šå†…å®¹ï¼Œåˆ›å»ºå®ŒæˆçŠ¶æ€çš„è§¦å‘å™¨
                    const trigger = document.getElementById('loadTrigger');
                    if (trigger) {
                        trigger.innerHTML = '<span>å·²åŠ è½½å…¨éƒ¨å›¾ç‰‡</span>';
                        trigger.style.pointerEvents = 'none';
                    } else {
                        // å¦‚æœæ²¡æœ‰è§¦å‘å™¨ï¼Œåˆ›å»ºä¸€ä¸ª
                        const finalTrigger = document.createElement('div');
                        finalTrigger.id = 'loadTrigger';
                        finalTrigger.style.cssText = `
                            height: 100px;
                            min-height: 100px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            color: #666;
                            font-size: 0.9rem;
                            pointer-events: none;
                            width: 100%;
                            margin-top: 20px;
                            clear: both;
                        `;
                        finalTrigger.innerHTML = '<span>å·²åŠ è½½å…¨éƒ¨å›¾ç‰‡</span>';

                        // æ·»åŠ åˆ°åˆé€‚çš„å®¹å™¨
                        let container;
                        if (state.currentView === 'grid') {
                            container = elements.masonryView;
                        } else if (state.currentView === 'comic') {
                            container = elements.comicView;
                        } else {
                            container = elements.masonryView;
                        }

                        if (container && container.style.display !== 'none') {
                            container.appendChild(finalTrigger);
                        }
                    }
                } else {
                    // é‡æ–°è®¾ç½®æ— é™æ»šåŠ¨ï¼Œç¡®ä¿æ–°çš„è§¦å‘å™¨ä½ç½®æ­£ç¡®
                    managedSetTimeout(() => {
                        setupInfiniteScroll();
                    }, 100);
                }

                console.log('åŠ è½½æ›´å¤šå›¾ç‰‡å®Œæˆï¼Œå½“å‰é¡µ:', state.currentPage, 'æ€»å›¾ç‰‡æ•°:', state.filteredImages.length);
            });
        }

        // å¸¦æ»šåŠ¨ä¿®å¤çš„ç½‘æ ¼è§†å›¾æ¸²æŸ“ - ä¸“é—¨ç”¨äºæ— é™æ»šåŠ¨
        function renderGridViewWithScrollFix(images, scrollPosition, isNearBottom) {
            elements.emptyState.classList.add('hidden');
            elements.imageCount.textContent = images.length;

            // ä½¿ç”¨DocumentFragmentæ‰¹é‡æ“ä½œDOM
            const fragment = document.createDocumentFragment();
            const startIndex = (state.currentPage - 1) * state.itemsPerPage;
            const newImages = images.slice(startIndex);

            // ä¸ºæ–°å¢å›¾ç‰‡åˆ›å»ºå…ƒç´ 
            newImages.forEach((image) => {
                const imageItem = createImageItem(image);
                if (imageItem) {
                    fragment.appendChild(imageItem);
                }
            });

            // åœ¨è¿½åŠ æ–°å†…å®¹å‰ï¼Œå…ˆç§»é™¤ç°æœ‰çš„loadTrigger
            const existingTrigger = document.getElementById('loadTrigger');
            if (existingTrigger) {
                existingTrigger.remove();
            }

            // è¿½åŠ æ–°å†…å®¹åˆ°ç°æœ‰å®¹å™¨
            elements.masonryView.appendChild(fragment);

            // ç¡®ä¿æ­£ç¡®çš„æ˜¾ç¤ºçŠ¶æ€
            elements.masonryView.classList.remove('hidden');
            elements.comicView.classList.add('hidden');
            elements.folderView.classList.add('hidden');

            // æ— é™æ»šåŠ¨æ—¶ä¸éœ€è¦æ¢å¤æ»šåŠ¨ä½ç½®ï¼Œä¿æŒç”¨æˆ·å½“å‰ä½ç½®
            console.log('ç½‘æ ¼è§†å›¾è¿½åŠ æ¸²æŸ“å®Œæˆï¼Œä¿æŒå½“å‰ä½ç½®');
        }

        // å¸¦æ»šåŠ¨ä¿®å¤çš„æ¡æ¼«è§†å›¾æ¸²æŸ“ - ä¸“é—¨ç”¨äºæ— é™æ»šåŠ¨
        function renderComicViewWithScrollFix(images, scrollPosition, isNearBottom) {
            elements.emptyState.classList.add('hidden');
            elements.imageCount.textContent = images.length;

            // ä½¿ç”¨DocumentFragmentæ‰¹é‡æ“ä½œDOM
            const fragment = document.createDocumentFragment();
            const startIndex = (state.currentPage - 1) * state.itemsPerPage;
            const newImages = images.slice(startIndex);

            // ä¸ºæ–°å¢å›¾ç‰‡åˆ›å»ºå…ƒç´ 
            newImages.forEach((image) => {
                const imageItem = createImageItem(image, 'comic');
                if (imageItem) {
                    fragment.appendChild(imageItem);
                }
            });

            // åœ¨è¿½åŠ æ–°å†…å®¹å‰ï¼Œå…ˆç§»é™¤ç°æœ‰çš„loadTrigger
            const existingTrigger = document.getElementById('loadTrigger');
            if (existingTrigger) {
                existingTrigger.remove();
            }

            // è¿½åŠ æ–°å†…å®¹åˆ°ç°æœ‰å®¹å™¨
            elements.comicView.appendChild(fragment);

            // ç¡®ä¿æ­£ç¡®çš„æ˜¾ç¤ºçŠ¶æ€
            elements.comicView.classList.remove('hidden');
            elements.masonryView.classList.add('hidden');
            elements.folderView.classList.add('hidden');

            // æ— é™æ»šåŠ¨æ—¶ä¸éœ€è¦æ¢å¤æ»šåŠ¨ä½ç½®ï¼Œä¿æŒç”¨æˆ·å½“å‰ä½ç½®
            console.log('æ¡æ¼«è§†å›¾è¿½åŠ æ¸²æŸ“å®Œæˆï¼Œä¿æŒå½“å‰ä½ç½®');
        }

        // æ—§ç‰ˆæœ¬ä¿ç•™ä½œä¸ºå¤‡ç”¨
        function loadMoreImages() {
            loadMoreImagesOptimized();
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // æ›´æ–°è¿”å›ç½®é¡¶æŒ‰é’®æ˜¾ç¤ºçŠ¶æ€
        function updateBackToTopButton() {
            if (window.scrollY > 300) {
                elements.backToTop.classList.add('visible');
            } else {
                elements.backToTop.classList.remove('visible');
            }
        }

        // é¡µé¢å¸è½½æ—¶æ¸…ç†æ‰€æœ‰URL
    window.addEventListener('beforeunload', () => {
        state.urlCache.forEach(url => {
            URL.revokeObjectURL(url);
        });
        state.urlCache.clear();
        state.urlCreationTime.clear();
    });

    init();
    </script>
</body>
</html>