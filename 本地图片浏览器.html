<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æœ¬åœ°å›¾ç‰‡æµè§ˆå™¨</title>
    <style>
        :root {
            --primary-color: #5d7db9;
            --secondary-color: #8aa7d6;
            --accent-color: #ff8a65;
            --light-color: #f9fbfd;
            --dark-color: #2c3e50;
            --border-color: #e1e8ed;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: var(--light-color);
            color: var(--dark-color);
            line-height: 1.6;
            padding: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        h1 {
            font-size: 2.4rem;
            margin-bottom: 10px;
        }
        
        .subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
        }
        
        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 15px; /* Reduced margin to fit breadcrumb */
            padding: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            align-items: center;
        }
        
        button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 18px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        button:hover {
            background-color: var(--secondary-color);
            transform: translateY(-2px);
        }
        
        button.active {
            background-color: var(--accent-color);
        }
        
        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
        }
        
        .file-input-wrapper input[type=file] {
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }
        
        .search-box {
            flex-grow: 1;
            min-width: 200px;
        }
        
        input[type="text"], select {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 1rem;
        }
        
        .view-options {
            display: flex;
            gap: 10px;
        }
        
        .image-counter {
            margin-left: auto;
            font-weight: 600;
            color: var(--primary-color);
        }

        /* é¢åŒ…å±‘å¯¼èˆªæ ·å¼ */
        .breadcrumb-bar {
            display: none; /* é»˜è®¤éšè—ï¼Œè¿›å…¥æ–‡ä»¶å¤¹æ—¶æ˜¾ç¤º */
            padding: 10px 20px;
            margin-bottom: 20px;
            background: #eef2f7;
            border-radius: 8px;
            font-size: 1rem;
            align-items: center;
            gap: 10px;
        }

        .breadcrumb-bar.visible {
            display: flex;
        }

        .breadcrumb-item {
            color: var(--primary-color);
            cursor: pointer;
            font-weight: 600;
        }

        .breadcrumb-item:hover {
            text-decoration: underline;
        }

        .breadcrumb-separator {
            color: #999;
        }

        .breadcrumb-current {
            color: var(--dark-color);
            font-weight: normal;
        }
        
        .masonry-grid:not(.hidden) {
            display: flex !important;
            flex-wrap: wrap !important;
            gap: 15px !important;
            margin-bottom: 30px;
            align-items: flex-start !important;
        }

        .masonry-grid.hidden {
            display: none !important;
        }

        .masonry-grid .image-item {
            flex: 0 0 calc(25% - 11.25px) !important;
            margin-bottom: 0 !important;
            width: calc(25% - 11.25px) !important;
            max-width: calc(25% - 11.25px) !important;
        }

        @media (max-width: 1200px) {
            .masonry-grid .image-item {
                flex: 0 0 calc(33.333% - 10px) !important;
                width: calc(33.333% - 10px) !important;
                max-width: calc(33.333% - 10px) !important;
            }
        }

        @media (max-width: 768px) {
            .masonry-grid .image-item {
                flex: 0 0 calc(50% - 7.5px) !important;
                width: calc(50% - 7.5px) !important;
                max-width: calc(50% - 7.5px) !important;
            }

            .controls {
                flex-direction: column;
                align-items: stretch;
            }

            .image-counter {
                margin-left: 0;
                text-align: center;
            }
        }

        @media (max-width: 480px) {
            .masonry-grid .image-item {
                flex: 0 0 100% !important;
                width: 100% !important;
                max-width: 100% !important;
            }
        }

        /* æ¡æ¼«é˜…è§ˆæ¨¡å¼æ ·å¼ */
        .comic-view:not(.hidden) {
            display: block !important;
            margin-bottom: 30px;
            text-align: center;
        }

        .comic-view.hidden {
            display: none !important;
        }

        .comic-view .image-item {
            display: block !important;
            width: 100% !important;
            max-width: 800px !important;
            margin: 0 auto 20px auto !important;
            text-align: center;
            flex: none !important;
        }

        .comic-view .image-item img {
            width: 100% !important;
            height: auto !important;
            max-height: none !important;
            object-fit: contain !important;
            margin: 0 auto !important;
            display: block !important;
        }

        .comic-view .image-info {
            text-align: left;
            width: 100%;
            padding: 12px 0;
        }

        @media (max-width: 900px) {
            .comic-view .image-item {
                max-width: calc(100% - 40px) !important;
                padding: 0 20px;
            }
        }

        @media (max-width: 480px) {
            .comic-view .image-item {
                max-width: calc(100% - 20px) !important;
                padding: 0 10px;
                margin-bottom: 15px !important;
            }
        }
        
        .image-item {
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s, box-shadow 0.3s;
            background: white;
            /* ç§»é™¤é»˜è®¤çš„flexå±æ€§ï¼Œé¿å…å¹²æ‰°ä¸åŒè§†å›¾æ¨¡å¼ */
        }
        
        .image-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        }
        
        .image-item img {
            width: 100%;
            height: auto;
            display: block;
            cursor: pointer;
            transition: transform 0.5s;
        }
        
        .image-item:hover img {
            transform: scale(1.03);
        }
        
        .image-info {
            padding: 12px;
            font-size: 0.9rem;
        }
        
        .image-name {
            font-weight: 600;
            margin-bottom: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .image-path {
            font-size: 0.8rem;
            color: #666;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .folder-view:not(.hidden) {
            display: block !important;
        }

        .folder-view.hidden {
            display: none !important;
        }
        
        .folder-item {
            margin-bottom: 20px;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
        }
        
        .folder-header {
            padding: 15px 20px;
            background-color: #f0f4f8;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background-color 0.2s;
        }

        .folder-header:hover {
            background-color: #e1eaf3;
        }

        .folder-header:hover .folder-name {
            text-decoration: underline;
        }
        
        .folder-name {
            font-weight: 600;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .folder-icon {
            font-size: 1.2rem;
        }
        
        .folder-images {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
            padding: 15px;
        }
        
        .folder-image {
            border-radius: 6px;
            overflow: hidden;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
            aspect-ratio: 1; /* ä¿æŒæ­£æ–¹å½¢ç¼©ç•¥å›¾ */
        }
        
        .folder-image img {
            width: 100%;
            height: 100%;
            object-fit: cover; /* å¡«å……æ­£æ–¹å½¢ */
            display: block;
            cursor: pointer;
            transition: transform 0.3s;
        }

        .folder-image:hover img {
            transform: scale(1.1);
        }
        
        .fullscreen-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            user-select: none;
        }
        
        .fullscreen-container {
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        }
        
        .fullscreen-image-wrapper {
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            position: relative;
        }
        
        .fullscreen-image-wrapper img {
            max-width: 100%;
            max-height: 100%;
            width: auto;
            height: auto;
            object-fit: contain;
            display: block;
            transition: transform 0.1s ease-out;
            transform-origin: center;
        }

        .fullscreen-image-wrapper img.zoomed {
            cursor: grab;
            max-width: none;
            max-height: none;
            object-fit: unset;
        }

        .fullscreen-image-wrapper img.zoomed:active {
            cursor: grabbing;
        }

        .fullscreen-image-wrapper img:not(.zoomed) {
            cursor: zoom-in;
        }
        
        .fullscreen-info {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0);
            color: white;
            padding: 10px 15px;
            text-align: left;
            pointer-events: none;
            z-index: 1002;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8), -1px -1px 2px rgba(0, 0, 0, 0.8);
            font-weight: 600;
        }

        .controls-hint {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.6);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.8rem;
            opacity: 0.9;
            text-shadow: none;
            font-weight: normal;
            pointer-events: none;
            z-index: 1002;
        }
        
        .close-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.5);
            border: none;
            color: white;
            font-size: 2rem;
            cursor: pointer;
            z-index: 1001;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: background 0.3s, transform 0.3s;
            outline: none;
        }
        
        .close-btn:hover {
            background: rgba(0, 0, 0, 0.8);
            transform: rotate(90deg) !important;
        }
        
        .nav-btn {
            position: fixed;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0, 0, 0, 0.5);
            border: none;
            color: white;
            font-size: 2rem;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: background 0.3s, transform 0.3s;
            z-index: 1001;
            outline: none;
        }
        
        .nav-btn:hover {
            background: rgba(0, 0, 0, 0.8);
            transform: translateY(-50%) scale(1.1) !important;
        }
        
        .prev-btn {
            left: 20px;
        }
        
        .next-btn {
            right: 20px;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: var(--primary-color);
            font-size: 1.1rem;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }
        
        .empty-state i {
            font-size: 3rem;
            margin-bottom: 15px;
            color: #ccc;
        }
        
        .hidden {
            display: none !important;
        }
        
        body.fullscreen-active {
            overflow: hidden;
        }

        /* è¿”å›ç½®é¡¶æŒ‰é’®æ ·å¼ */
        .back-to-top {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 50px;
            height: 50px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 1.5rem;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: all 0.3s ease;
            z-index: 999;
            opacity: 0;
            visibility: hidden;
            box-shadow: 0 4px 12px rgba(93, 125, 185, 0.3);
        }

        .back-to-top.visible {
            opacity: 1;
            visibility: visible;
        }

        .back-to-top:hover {
            background: var(--secondary-color);
            transform: translateY(-3px);
            box-shadow: 0 6px 16px rgba(93, 125, 185, 0.4);
        }
    </style>
</head>
<body>
    <header>
        <h1>æœ¬åœ°å›¾ç‰‡æµè§ˆå™¨</h1>
        <p class="subtitle">é€‰æ‹©æœ¬åœ°æ–‡ä»¶å¤¹ï¼Œæµè§ˆå’Œç®¡ç†æ‚¨çš„å›¾ç‰‡æ”¶è—</p>
    </header>
    
    <div class="controls">
        <div class="file-input-wrapper">
            <button>
                <i>ğŸ“</i> é€‰æ‹©å›¾ç‰‡æ–‡ä»¶å¤¹
            </button>
            <input type="file" id="folderInput" webkitdirectory directory multiple>
        </div>
        
        <div class="search-box">
            <input type="text" id="searchInput" placeholder="æœç´¢å›¾ç‰‡åç§°..." disabled>
        </div>
        
        <select id="sortSelect" disabled>
            <option value="name">æŒ‰åç§°æ’åº</option>
            <option value="random">éšæœºæ’åº</option>
            <option value="date">æŒ‰æ—¥æœŸæ’åº</option>
        </select>
        
        <div class="view-options">
            <button id="gridViewBtn" class="active" disabled>
                <i>ğŸ–¼ï¸</i> ç½‘æ ¼è§†å›¾
            </button>
            <button id="folderViewBtn" disabled>
                <i>ğŸ“‚</i> æ–‡ä»¶å¤¹è§†å›¾
            </button>
            <button id="comicViewBtn" disabled>
                <i>ğŸ“œ</i> æ¡æ¼«é˜…è§ˆ
            </button>
        </div>
        
        <div class="image-counter">
            å·²åŠ è½½ <span id="imageCount">0</span> å¼ å›¾ç‰‡
        </div>
    </div>

    <div id="breadcrumbBar" class="breadcrumb-bar">
        <span class="breadcrumb-item" id="breadcrumbAll">å…¨éƒ¨å›¾ç‰‡</span>
        <span class="breadcrumb-separator">></span>
        <span class="breadcrumb-current" id="breadcrumbFolder">å½“å‰æ–‡ä»¶å¤¹</span>
    </div>
    
    <div id="masonryView" class="masonry-grid">
        </div>

    <div id="comicView" class="comic-view hidden">
        </div>

    <div id="folderView" class="folder-view hidden">
        </div>
    
    <div id="loadingIndicator" class="loading hidden">
        <p>åŠ è½½æ›´å¤šå›¾ç‰‡ä¸­...</p>
    </div>
    
    <div id="emptyState" class="empty-state">
        <i>ğŸ“·</i>
        <h3>æš‚æ— å›¾ç‰‡</h3>
        <p>è¯·é€‰æ‹©ä¸€ä¸ªåŒ…å«å›¾ç‰‡çš„æ–‡ä»¶å¤¹å¼€å§‹æµè§ˆ</p>
    </div>
    
    <div class="fullscreen-overlay" id="fullscreenOverlay">
        <button class="close-btn" id="closeFullscreen" title="å…³é—­ (Esc)">Ã—</button>
        <button class="nav-btn prev-btn" id="prevBtn" title="ä¸Šä¸€å¼  (â†)">â€¹</button>
        <button class="nav-btn next-btn" id="nextBtn" title="ä¸‹ä¸€å¼  (â†’)">â€º</button>
        <div class="fullscreen-container">
            <div class="fullscreen-image-wrapper" id="imageWrapper">
                <img id="fullscreenImage" src="" alt="å…¨å±å›¾ç‰‡" draggable="false">
            </div>
            <div class="fullscreen-info">
                <p id="fullscreenCaption"></p>
            </div>
            <div class="controls-hint">
                (å•å‡»åˆ‡æ¢100% / æ»šåŠ¨ç¼©æ”¾ / æ‹–æ‹½ç§»åŠ¨)
            </div>
        </div>
    </div>

    <!-- è¿”å›ç½®é¡¶æŒ‰é’® -->
    <button class="back-to-top" id="backToTop" title="è¿”å›é¡¶éƒ¨">â†‘</button>

    <script>
        // çŠ¶æ€ç®¡ç†
        let state = {
            images: [],
            filteredImages: [],
            currentView: 'grid', // 'grid', 'folder', 'comic'
            activeFolder: null,  // å½“å‰è¿›å…¥çš„ç‰¹å®šæ–‡ä»¶å¤¹ï¼Œnull è¡¨ç¤ºæŸ¥çœ‹æ‰€æœ‰
            sortBy: 'name',
            searchQuery: '',
            currentPage: 1,
            itemsPerPage: 12,
            fullscreenIndex: 0,
            urlCache: new Map(), // ç¼“å­˜URLå¯¹è±¡
            loadedImages: new Set(), // è®°å½•å·²åŠ è½½çš„å›¾ç‰‡
            folderCache: new Map(), // ç¼“å­˜æ–‡ä»¶å¤¹åˆ†ç»„æ•°æ®
            isViewSwitching: false // è§†å›¾åˆ‡æ¢æ ‡è¯†
        };

        // ç¼©æ”¾å’Œæ‹–æ‹½çŠ¶æ€
        let zoomState = {
            isZoomed: false,
            scale: 1,
            panning: false,
            pointX: 0,
            pointY: 0,
            translateX: 0,
            translateY: 0,
            hasMoved: false
        };

        // è§†å›¾åˆ‡æ¢æ§åˆ¶çŠ¶æ€
        let viewSwitchProtection = {
            isSwitching: false,
            startTime: 0,
            protectionDuration: 2000 // 2ç§’ä¿æŠ¤æ—¶é—´
        };

        // DOM å…ƒç´ 
        const elements = {
            folderInput: document.getElementById('folderInput'),
            searchInput: document.getElementById('searchInput'),
            sortSelect: document.getElementById('sortSelect'),
            gridViewBtn: document.getElementById('gridViewBtn'),
            folderViewBtn: document.getElementById('folderViewBtn'),
            comicViewBtn: document.getElementById('comicViewBtn'),
            masonryView: document.getElementById('masonryView'),
            comicView: document.getElementById('comicView'),
            folderView: document.getElementById('folderView'),
            breadcrumbBar: document.getElementById('breadcrumbBar'),
            breadcrumbAll: document.getElementById('breadcrumbAll'),
            breadcrumbFolder: document.getElementById('breadcrumbFolder'),
            imageCount: document.getElementById('imageCount'),
            loadingIndicator: document.getElementById('loadingIndicator'),
            emptyState: document.getElementById('emptyState'),
            fullscreenOverlay: document.getElementById('fullscreenOverlay'),
            imageWrapper: document.getElementById('imageWrapper'),
            fullscreenImage: document.getElementById('fullscreenImage'),
            fullscreenCaption: document.getElementById('fullscreenCaption'),
            closeFullscreen: document.getElementById('closeFullscreen'),
            prevBtn: document.getElementById('prevBtn'),
            nextBtn: document.getElementById('nextBtn'),
            backToTop: document.getElementById('backToTop')
        };

        // åˆå§‹åŒ–
        function init() {
            state.images = [];
            state.filteredImages = [];
            state.isLoading = false; // æ·»åŠ åŠ è½½çŠ¶æ€æ ‡è¯†
            renderImages();
            setupEventListeners();

            // é¡µé¢å¸è½½æ—¶æ¸…ç†èµ„æº
            window.addEventListener('beforeunload', cleanupResources);

            // ç›‘å¬é¡µé¢å¯è§æ€§å˜åŒ–ï¼Œä¼˜åŒ–æ€§èƒ½
            document.addEventListener('visibilitychange', handleVisibilityChange);

            // æ·»åŠ å†…å­˜æ¸…ç†å®šæ—¶å™¨
            setInterval(cleanupUnusedUrls, 60000); // æ¯åˆ†é’Ÿæ¸…ç†ä¸€æ¬¡
        }

        // æ¸…ç†èµ„æº
        function cleanupResources() {
            clearUrlCache();
            state.folderCache.clear();
            state.loadedImages.clear();

            // æ–­å¼€æ— é™æ»šåŠ¨è§‚å¯Ÿå™¨
            if (state.infiniteScrollObserver) {
                state.infiniteScrollObserver.disconnect();
            }
        }

        // å¤„ç†é¡µé¢å¯è§æ€§å˜åŒ–
        function handleVisibilityChange() {
            if (document.hidden) {
                // é¡µé¢éšè—æ—¶æš‚åœä¸å¿…è¦çš„æ“ä½œ
                console.log('é¡µé¢éšè—ï¼Œæš‚åœæ€§èƒ½å¯†é›†å‹æ“ä½œ');
            } else {
                // é¡µé¢æ˜¾ç¤ºæ—¶æ¢å¤æ“ä½œ
                console.log('é¡µé¢æ˜¾ç¤ºï¼Œæ¢å¤æ­£å¸¸æ“ä½œ');
            }
        }

        // æ¸…ç†æœªä½¿ç”¨çš„URL
        function cleanupUnusedUrls() {
            // è·å–å½“å‰é¡µé¢ä¸­å®é™…ä½¿ç”¨çš„å›¾ç‰‡
            const currentImages = document.querySelectorAll('img[data-src], img[src]');
            const usedUrls = new Set();

            currentImages.forEach(img => {
                if (img.dataset.src) {
                    usedUrls.add(img.dataset.src);
                }
                if (img.src && !img.src.startsWith('data:image/svg+xml')) {
                    usedUrls.add(img.src);
                }
            });

            // æ¸…ç†ä¸å†ä½¿ç”¨çš„URL
            for (const [key, url] of state.urlCache.entries()) {
                if (!usedUrls.has(url)) {
                    URL.revokeObjectURL(url);
                    state.urlCache.delete(key);
                }
            }

            console.log(`å·²æ¸…ç† ${state.urlCache.size} ä¸ªç¼“å­˜çš„URL`);
        }

        // æ¸…ç†URLç¼“å­˜
        function clearUrlCache() {
            state.urlCache.forEach((url, key) => {
                URL.revokeObjectURL(url);
            });
            state.urlCache.clear();
        }

        // è·å–æˆ–åˆ›å»ºå›¾ç‰‡URL
        function getImageUrl(file) {
            const fileKey = `${file.name}_${file.size}_${file.lastModified}`;
            if (!state.urlCache.has(fileKey)) {
                const url = URL.createObjectURL(file);
                state.urlCache.set(fileKey, url);
            }
            return state.urlCache.get(fileKey);
        }

        // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
        function setupEventListeners() {
            // æ–‡ä»¶å¤¹é€‰æ‹©
            elements.folderInput.addEventListener('change', handleFolderSelect);
            
            // æœç´¢
            elements.searchInput.addEventListener('input', debounce(() => {
                state.searchQuery = elements.searchInput.value;
                filterAndSortImages();
                renderImages();
            }, 300));
            
            // æ’åº
            elements.sortSelect.addEventListener('change', () => {
                state.sortBy = elements.sortSelect.value;
                filterAndSortImages();
                renderImages();
            });
            
            // è§†å›¾åˆ‡æ¢ (ç‚¹å‡»é¡¶éƒ¨æŒ‰é’®è§†ä¸ºé‡ç½®åˆ°æŸ¥çœ‹æ‰€æœ‰)
            elements.gridViewBtn.addEventListener('click', () => {
                state.activeFolder = null; // é‡ç½®æ–‡ä»¶å¤¹è¿‡æ»¤
                state.searchQuery = ''; // æ¸…ç©ºæœç´¢
                elements.searchInput.value = '';
                switchView('grid');
            });
            elements.folderViewBtn.addEventListener('click', () => {
                state.activeFolder = null; // é‡ç½®æ–‡ä»¶å¤¹è¿‡æ»¤
                state.searchQuery = ''; // æ¸…ç©ºæœç´¢
                elements.searchInput.value = '';
                switchView('folder');
            });
            elements.comicViewBtn.addEventListener('click', () => {
                // æ¡æ¼«æ¨¡å¼çš„ç‰¹æ®Šå¤„ç†ï¼š
                // å¦‚æœå½“å‰åœ¨æ–‡ä»¶å¤¹å†…ï¼Œä¿æŒactiveFolderä¸å˜
                // å¦‚æœåœ¨å…¨å±€è§†å›¾ï¼Œä¹Ÿä¿æŒactiveFolderä¸å˜ï¼ˆå·²ç»æ˜¯nullï¼‰
                switchView('comic');
            });
            
            // é¢åŒ…å±‘å¯¼èˆªç‚¹å‡»
            elements.breadcrumbAll.addEventListener('click', () => {
                state.activeFolder = null;
                // è¿”å›åˆ°ä¹‹å‰çš„è§†å›¾æ¨¡å¼ï¼Œé€šå¸¸æ˜¯æ–‡ä»¶å¤¹è§†å›¾æˆ–æ€»ç½‘æ ¼è§†å›¾
                // è¿™é‡Œé€»è¾‘ï¼šå¦‚æœä¹‹å‰æ˜¯åœ¨æ–‡ä»¶å¤¹é‡Œï¼Œç‚¹å‡»è¿”å›é€šå¸¸æ˜¯å›åˆ°æ–‡ä»¶å¤¹åˆ—è¡¨
                switchView('folder'); 
            });

            // å…¨å±æŸ¥çœ‹ä¸äº¤äº’
            elements.closeFullscreen.addEventListener('click', closeFullscreen);
            elements.prevBtn.addEventListener('click', (e) => { e.stopPropagation(); showPrevImage(); });
            elements.nextBtn.addEventListener('click', (e) => { e.stopPropagation(); showNextImage(); });
            
            elements.fullscreenOverlay.addEventListener('click', (e) => {
                if (e.target === elements.fullscreenOverlay || e.target === elements.imageWrapper) {
                    closeFullscreen();
                }
            });
            
            setupImageInteractions();

            // è¿”å›ç½®é¡¶æŒ‰é’®
            elements.backToTop.addEventListener('click', () => {
                window.scrollTo({
                    top: 0,
                    behavior: 'smooth'
                });
            });

            // ä¼˜åŒ–çš„æ— é™æ»šåŠ¨ - ä½¿ç”¨Intersection Observer
            setupInfiniteScroll();
            window.addEventListener('scroll', debounce(() => {
                // æ›´æ–°è¿”å›ç½®é¡¶æŒ‰é’®æ˜¾ç¤ºçŠ¶æ€
                updateBackToTopButton();
            }, 200));
            
            // é”®ç›˜å¯¼èˆª
            document.addEventListener('keydown', (e) => {
                if (elements.fullscreenOverlay.style.display === 'flex') {
                    if (e.key === 'Escape') closeFullscreen();
                    if (e.key === 'ArrowLeft') showPrevImage();
                    if (e.key === 'ArrowRight') showNextImage();
                }
            });
        }

        // è®¾ç½®å›¾ç‰‡ç¼©æ”¾å’Œæ‹–æ‹½äº¤äº’
        function setupImageInteractions() {
            const img = elements.fullscreenImage;
            const wrapper = elements.imageWrapper;

            img.addEventListener('click', (e) => {
                if (zoomState.hasMoved) {
                    zoomState.hasMoved = false;
                    return;
                }
                toggleZoom(e);
            });

            wrapper.addEventListener('wheel', (e) => {
                e.preventDefault();
                const delta = e.deltaY > 0 ? 0.9 : 1.1;
                let newScale = zoomState.scale * delta;
                if (newScale < 0.1) newScale = 0.1;
                if (newScale > 10) newScale = 10;
                zoomState.scale = newScale;
                enableZoomMode();
                updateImageTransform();
            }, { passive: false });

            img.addEventListener('mousedown', (e) => {
                if (!zoomState.isZoomed && zoomState.scale <= 1) return;
                e.preventDefault();
                zoomState.panning = true;
                zoomState.pointX = e.clientX - zoomState.translateX;
                zoomState.pointY = e.clientY - zoomState.translateY;
                zoomState.hasMoved = false;
                img.style.cursor = 'grabbing';
            });

            window.addEventListener('mousemove', (e) => {
                if (!zoomState.panning) return;
                e.preventDefault();
                const newX = e.clientX - zoomState.pointX;
                const newY = e.clientY - zoomState.pointY;
                if (Math.abs(newX - zoomState.translateX) > 2 || Math.abs(newY - zoomState.translateY) > 2) {
                    zoomState.hasMoved = true;
                }
                zoomState.translateX = newX;
                zoomState.translateY = newY;
                updateImageTransform();
            });

            window.addEventListener('mouseup', () => {
                if (zoomState.panning) {
                    zoomState.panning = false;
                    img.style.cursor = zoomState.isZoomed || zoomState.scale > 1 ? 'grab' : 'zoom-in';
                }
            });
        }

        function toggleZoom(e) {
            if (zoomState.isZoomed) {
                resetZoom();
            } else {
                zoomState.isZoomed = true;
                zoomState.scale = 1;
                zoomState.translateX = 0;
                zoomState.translateY = 0;
                enableZoomMode();
                updateImageTransform();
            }
        }

        function enableZoomMode() {
            elements.fullscreenImage.classList.add('zoomed');
        }

        function resetZoom() {
            zoomState.isZoomed = false;
            zoomState.scale = 1;
            zoomState.translateX = 0;
            zoomState.translateY = 0;
            elements.fullscreenImage.classList.remove('zoomed');
            elements.fullscreenImage.style.transform = '';
        }

        function updateImageTransform() {
            if (elements.fullscreenImage.classList.contains('zoomed')) {
                 elements.fullscreenImage.style.transform = 
                    `translate(${zoomState.translateX}px, ${zoomState.translateY}px) scale(${zoomState.scale})`;
            }
        }

        // å¤„ç†æ–‡ä»¶å¤¹é€‰æ‹©
        function handleFolderSelect(event) {
            const files = Array.from(event.target.files);
            const imageFiles = files.filter(file => file.type.startsWith('image/'));

            if (imageFiles.length === 0) {
                alert('æ‰€é€‰æ–‡ä»¶å¤¹ä¸­æ²¡æœ‰æ‰¾åˆ°å›¾ç‰‡æ–‡ä»¶');
                return;
            }

            // æ¸…ç†ä¹‹å‰çš„URLç¼“å­˜
            clearUrlCache();
            state.folderCache.clear();
            state.loadedImages.clear();

            elements.searchInput.disabled = false;
            elements.sortSelect.disabled = false;
            elements.gridViewBtn.disabled = false;
            elements.folderViewBtn.disabled = false;
            elements.comicViewBtn.disabled = false;

            state.images = imageFiles.map((file, index) => {
                const path = file.webkitRelativePath || file.name;
                const pathParts = path.split('/');
                const folder = pathParts.length > 1 ? pathParts.slice(0, -1).join('/') : 'æ ¹ç›®å½•';

                return {
                    name: file.name,
                    path: path,
                    folder: folder,
                    date: new Date(file.lastModified).toISOString().split('T')[0],
                    file: file,
                    url: getImageUrl(file), // ä½¿ç”¨ç¼“å­˜çš„URL
                    fileKey: `${file.name}_${file.size}_${file.lastModified}`
                };
            });

            state.activeFolder = null;
            state.currentPage = 1;

            // æ˜¾ç¤ºåŠ è½½æç¤º
            showLoadingTip('æ­£åœ¨å¤„ç†å›¾ç‰‡æ•°æ®...');

            // ä½¿ç”¨setTimeouté¿å…é˜»å¡UI
            setTimeout(() => {
                filterAndSortImages();
                renderImages();

                // è®¾ç½®æ— é™æ»šåŠ¨ï¼ˆç¬¬ä¸€æ¬¡åŠ è½½ä¹Ÿéœ€è¦ï¼‰
                setTimeout(() => {
                    setupInfiniteScroll();
                }, 100);

                hideLoadingTip();
            }, 100);
        }

        // æ˜¾ç¤ºåŠ è½½æç¤º
        function showLoadingTip(message) {
            const tip = document.createElement('div');
            tip.id = 'loadingTip';
            tip.className = 'loading-tip';
            tip.textContent = message;
            tip.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: rgba(0, 0, 0, 0.8);
                color: white;
                padding: 15px 25px;
                border-radius: 8px;
                z-index: 2000;
                font-size: 1.1rem;
            `;
            document.body.appendChild(tip);
        }

        // éšè—åŠ è½½æç¤º
        function hideLoadingTip() {
            const tip = document.getElementById('loadingTip');
            if (tip) {
                tip.remove();
            }
        }

        // è¿›å…¥ç‰¹å®šæ–‡ä»¶å¤¹
        function enterFolder(folderName) {
            // å¯åŠ¨è§†å›¾åˆ‡æ¢ä¿æŠ¤
            viewSwitchProtection.isSwitching = true;
            viewSwitchProtection.startTime = Date.now();
            state.isViewSwitching = true;

            state.activeFolder = folderName;
            state.searchQuery = ''; // æ¸…ç©ºæœç´¢ï¼Œæˆ–è€…ä¿ç•™çœ‹éœ€æ±‚ï¼Œé€šå¸¸è¿›å…¥æ–‡ä»¶å¤¹æƒ³çœ‹æ‰€æœ‰çš„
            elements.searchInput.value = '';
            state.currentPage = 1; // é‡ç½®åˆ†é¡µ

            // å¼ºåˆ¶åˆ‡æ¢åˆ°ç½‘æ ¼è§†å›¾ï¼Œè¿™æ˜¯è¿›å…¥æ–‡ä»¶å¤¹åçš„é»˜è®¤è§†å›¾
            // ä¸è°ƒç”¨switchViewï¼Œé¿å…é¢å¤–çš„çŠ¶æ€é‡ç½®
            state.currentView = 'grid';

            // é‡æ–°è®¡ç®—è¿‡æ»¤
            filterAndSortImages();

            // æ›´æ–°æŒ‰é’®çŠ¶æ€å’Œé¢åŒ…å±‘
            updateBreadcrumb();
            elements.gridViewBtn.classList.remove('active');
            elements.folderViewBtn.classList.remove('active');
            elements.comicViewBtn.classList.remove('active');

            // æ˜¾ç¤º/éšè—è§†å›¾
            elements.masonryView.style.display = 'flex';
            elements.comicView.style.display = 'none';
            elements.folderView.style.display = 'none';

            // é‡æ–°æ¸²æŸ“
            renderImages();

            // é‡ç½®æ— é™æ»šåŠ¨
            setTimeout(() => {
                setupInfiniteScroll();

                // åœ¨ä¿æŠ¤æœŸç»“æŸåé‡ç½®çŠ¶æ€
                setTimeout(() => {
                    state.isViewSwitching = false;
                    viewSwitchProtection.isSwitching = false;
                }, viewSwitchProtection.protectionDuration);
            }, 100);
        }

        // è¿‡æ»¤å’Œæ’åºå›¾ç‰‡
        function filterAndSortImages() {
            let sourceImages = state.images;

            // 1. é¦–å…ˆæŒ‰æ–‡ä»¶å¤¹è¿‡æ»¤ï¼ˆå¦‚æœæ¿€æ´»äº†ç‰¹å®šæ–‡ä»¶å¤¹ï¼‰
            if (state.activeFolder) {
                sourceImages = sourceImages.filter(img => img.folder === state.activeFolder);
            }

            // 2. ç„¶åæŒ‰æœç´¢å…³é”®è¯è¿‡æ»¤
            state.filteredImages = sourceImages.filter(img => 
                img.name.toLowerCase().includes(state.searchQuery.toLowerCase()) ||
                img.path.toLowerCase().includes(state.searchQuery.toLowerCase())
            );
            
            // 3. æ’åº
            switch (state.sortBy) {
                case 'name':
                    state.filteredImages.sort((a, b) => a.name.localeCompare(b.name));
                    break;
                case 'date':
                    state.filteredImages.sort((a, b) => new Date(b.date) - new Date(a.date));
                    break;
                case 'random':
                    for (let i = state.filteredImages.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [state.filteredImages[i], state.filteredImages[j]] = [state.filteredImages[j], state.filteredImages[i]];
                    }
                    break;
            }
        }

        // åˆ‡æ¢è§†å›¾
        function switchView(view) {
            // è®°å½•ä¹‹å‰çš„è§†å›¾ï¼Œç”¨äºåˆ¤æ–­æ˜¯å¦éœ€è¦é‡æ–°è¿‡æ»¤
            const previousView = state.currentView;

            // å¯åŠ¨è§†å›¾åˆ‡æ¢ä¿æŠ¤
            viewSwitchProtection.isSwitching = true;
            viewSwitchProtection.startTime = Date.now();

            state.isViewSwitching = true;
            state.currentView = view;
            state.currentPage = 1;

            // é‡æ–°è®¡ç®—è¿‡æ»¤çš„é€»è¾‘ï¼š
            // 1. ä»æ–‡ä»¶å¤¹è§†å›¾åˆ‡æ¢åˆ°å…¶ä»–è§†å›¾æ—¶ï¼Œéœ€è¦é‡æ–°è¿‡æ»¤ï¼ˆå› ä¸ºæ•°æ®ç»“æ„ä¸åŒï¼‰
            // 2. åˆ‡æ¢åˆ°æ–‡ä»¶å¤¹è§†å›¾æ—¶ï¼Œéœ€è¦é‡æ–°è¿‡æ»¤ï¼ˆæ˜¾ç¤ºæ‰€æœ‰å›¾ç‰‡çš„åˆ†ç»„ï¼‰
            // 3. åœ¨activeFolderæ¨¡å¼ä¸‹åˆ‡æ¢è§†å›¾æ—¶ï¼Œéœ€è¦é‡æ–°åº”ç”¨æ–‡ä»¶å¤¹è¿‡æ»¤
            const shouldRefilter =
                previousView === 'folder' || // ä»æ–‡ä»¶å¤¹è§†å›¾åˆ‡æ¢å‡ºæ¥
                view === 'folder' || // åˆ‡æ¢åˆ°æ–‡ä»¶å¤¹è§†å›¾
                state.activeFolder !== null; // åœ¨activeFolderæ¨¡å¼ä¸‹åˆ‡æ¢

            if (shouldRefilter) {
                filterAndSortImages();
            }

            // æ›´æ–°é¢åŒ…å±‘
            updateBreadcrumb();

            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            // å¦‚æœåœ¨ activeFolder æ¨¡å¼ä¸‹ï¼Œé¡¶éƒ¨æŒ‰é’®çŠ¶æ€é€»è¾‘ï¼š
            if (state.activeFolder) {
                elements.gridViewBtn.classList.remove('active');
                elements.folderViewBtn.classList.remove('active');
                elements.comicViewBtn.classList.toggle('active', view === 'comic');
            } else {
                elements.gridViewBtn.classList.toggle('active', view === 'grid');
                elements.folderViewBtn.classList.toggle('active', view === 'folder');
                elements.comicViewBtn.classList.toggle('active', view === 'comic');
            }

            // æ˜¾ç¤º/éšè—è§†å›¾
            elements.masonryView.style.display = view === 'grid' ? 'flex' : 'none';
            elements.comicView.style.display = view === 'comic' ? 'block' : 'none';
            elements.folderView.style.display = view === 'folder' ? 'block' : 'none';

            // é‡æ–°æ¸²æŸ“ - ä½¿ç”¨åŒé‡requestAnimationFrameç¡®ä¿DOMå®Œå…¨æ›´æ–°
            requestAnimationFrame(() => {
                renderImages();

                // ç¡®ä¿DOMæ›´æ–°å®Œæˆåå†è®¾ç½®æ— é™æ»šåŠ¨
                requestAnimationFrame(() => {
                    setupInfiniteScroll();

                    // åœ¨ä¿æŠ¤æœŸç»“æŸåé‡ç½®çŠ¶æ€
                    setTimeout(() => {
                        state.isViewSwitching = false;
                        viewSwitchProtection.isSwitching = false;
                    }, viewSwitchProtection.protectionDuration);
                });
            });
        }

        // æ›´æ–°é¢åŒ…å±‘å¯¼èˆª
        function updateBreadcrumb() {
            if (state.activeFolder) {
                elements.breadcrumbBar.classList.add('visible');
                elements.breadcrumbFolder.textContent = state.activeFolder;
                // åœ¨æ–‡ä»¶å¤¹æ¨¡å¼ä¸‹ï¼Œé¡¶éƒ¨è§†å›¾æŒ‰é’®ç¦ç”¨æˆ–è§†è§‰ä¸Šå˜ç°å¯èƒ½æ›´å¥½ï¼Œä½†è¿™é‡Œæˆ‘ä»¬ä¿æŒå¯ç”¨ä½œä¸º"Reset"æ‰‹æ®µ
            } else {
                elements.breadcrumbBar.classList.remove('visible');
            }
        }

        // æ¸²æŸ“å›¾ç‰‡ - ä¼˜åŒ–ç‰ˆæœ¬
        function renderImages() {
            const visibleImages = state.filteredImages.slice(0, state.currentPage * state.itemsPerPage);

            if (visibleImages.length === 0) {
                elements.emptyState.classList.remove('hidden');
                elements.masonryView.classList.add('hidden');
                elements.comicView.classList.add('hidden');
                elements.folderView.classList.add('hidden');
                elements.imageCount.textContent = '0';
                return;
            }

            elements.emptyState.classList.add('hidden');
            elements.imageCount.textContent = visibleImages.length;

            // ä½¿ç”¨requestAnimationFrameä¼˜åŒ–æ¸²æŸ“æ—¶æœº
            requestAnimationFrame(() => {
                if (state.currentView === 'grid') {
                    renderGridView(visibleImages);
                } else if (state.currentView === 'comic') {
                    renderComicView(visibleImages);
                } else if (state.currentView === 'folder' && !state.activeFolder) {
                    // åªæœ‰åœ¨æ–‡ä»¶å¤¹è§†å›¾æ¨¡å¼ä¸”æ²¡æœ‰activeFolderæ—¶æ‰æ¸²æŸ“æ–‡ä»¶å¤¹è§†å›¾
                    renderFolderView(state.filteredImages);
                } else {
                    // å¦‚æœæ˜¯activeFolderæ¨¡å¼ï¼Œä½†æ„å¤–è¿›å…¥äº†æ–‡ä»¶å¤¹è§†å›¾ï¼Œå¼ºåˆ¶åˆ‡æ¢åˆ°ç½‘æ ¼è§†å›¾
                    console.warn('æ£€æµ‹åˆ°activeFolderæ¨¡å¼ä¸‹å°è¯•æ¸²æŸ“æ–‡ä»¶å¤¹è§†å›¾ï¼Œè‡ªåŠ¨åˆ‡æ¢åˆ°ç½‘æ ¼è§†å›¾');
                    state.currentView = 'grid';
                    renderGridView(visibleImages);
                }
            });
        }

        // ä¼˜åŒ–çš„ç½‘æ ¼è§†å›¾æ¸²æŸ“
        function renderGridView(images) {
            // ä½¿ç”¨DocumentFragmentæ‰¹é‡æ“ä½œDOM
            const fragment = document.createDocumentFragment();

            // è®¡ç®—å…¨å±€ç´¢å¼•åç§»é‡
            const startIndex = (state.currentPage - 1) * state.itemsPerPage;

            images.forEach((image, localIndex) => {
                const globalIndex = startIndex + localIndex;
                const imageItem = createImageItem(image, globalIndex);
                fragment.appendChild(imageItem);
            });

            // ä¸€æ¬¡æ€§æ›´æ–°DOM
            elements.masonryView.innerHTML = '';
            elements.masonryView.appendChild(fragment);

            elements.masonryView.classList.remove('hidden');
            elements.comicView.classList.add('hidden');
            elements.folderView.classList.add('hidden');
        }

        // ä¼˜åŒ–çš„å›¾ç‰‡é¡¹å…ƒç´ åˆ›å»º - æ”¯æŒæ‡’åŠ è½½å’Œæ­£ç¡®çš„å…¨å±€ç´¢å¼•
        function createImageItem(image, globalIndex) {
            const imageItem = document.createElement('div');
            imageItem.className = 'image-item';

            // åˆ›å»ºå›¾ç‰‡å ä½ç¬¦
            const img = document.createElement('img');
            img.alt = image.name;
            img.dataset.globalIndex = globalIndex; // ä½¿ç”¨å…¨å±€ç´¢å¼•
            img.dataset.src = image.url; // ä½¿ç”¨data-srcè¿›è¡Œæ‡’åŠ è½½
            img.loading = 'lazy';

            // åˆå§‹æ˜¾ç¤ºä½è´¨é‡å ä½å›¾
            img.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgdmlld0JveD0iMCAwIDIwMCAyMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIyMDAiIGhlaWdodD0iMjAwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik04NSA2NUgxMTVWMTE1SDg1VjY1WiIgZmlsbD0iI0QxRDFEMSIvPgo8cGF0aCBkPSJNMTAwIDg1TDg1IDEwNUgxMTVMMTAwIDg1WiIgZmlsbD0iI0QxRDFEMSIvPgo8dGV4dCB4PSIxMDAiIHk9IjEzMCIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZmlsbD0iIzk5OTk5OSIgZm9udC1zaXplPSIxNCIgZm9udC1mYW1pbHk9IkFyaWFsIj7lm6DmgYXmlbDmjaI8L3RleHQ+Cjwvc3ZnPgo=';

            // è®¾ç½®æ‡’åŠ è½½
            setupLazyLoading(img);

            // æ·»åŠ å›¾ç‰‡åŠ è½½é”™è¯¯å¤„ç†
            img.addEventListener('error', function() {
                this.onerror = null;
                this.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgdmlld0JveD0iMCAwIDIwMCAyMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIyMDAiIGhlaWdodD0iMjAwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik04NSA2NUgxMTVWMTE1SDg1VjY1WiIgZmlsbD0iI0QxRDFEMSIvPgo8cGF0aCBkPSJNMTAwIDg1TDg1IDEwNUgxMTVMMTAwIDg1WiIgZmlsbD0iI0QxRDFEMSIvPgo8dGV4dCB4PSIxMDAiIHk9IjEzMCIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZmlsbD0iIzk5OTk5OSIgZm9udC1zaXplPSIxNCIgZm9udC1mYW1pbHk9IkFyaWFsIj7kuK3vvIzlm6DmgYXmlbDmjaI8L3RleHQ+Cjwvc3ZnPgo=';
            });

            // æ·»åŠ ç‚¹å‡»äº‹ä»¶ - ä½¿ç”¨å…¨å±€ç´¢å¼•
            img.addEventListener('click', () => openFullscreen(globalIndex));

            // åˆ›å»ºå›¾ç‰‡ä¿¡æ¯
            const imageInfo = document.createElement('div');
            imageInfo.className = 'image-info';

            const imageName = document.createElement('div');
            imageName.className = 'image-name';
            imageName.textContent = image.name;

            const imagePath = document.createElement('div');
            imagePath.className = 'image-path';
            imagePath.textContent = image.path;

            imageInfo.appendChild(imageName);
            imageInfo.appendChild(imagePath);

            imageItem.appendChild(img);
            imageItem.appendChild(imageInfo);

            return imageItem;
        }

        // è®¾ç½®å›¾ç‰‡æ‡’åŠ è½½
        function setupLazyLoading(img) {
            // å¦‚æœæµè§ˆå™¨åŸç”Ÿæ”¯æŒæ‡’åŠ è½½ä¸”å›¾ç‰‡åœ¨è§†å£å†…ï¼Œç›´æ¥åŠ è½½
            if ('loading' in HTMLImageElement && isVisible(img)) {
                img.src = img.dataset.src;
                return;
            }

            // åˆ›å»ºIntersection Observerè¿›è¡Œæ‡’åŠ è½½
            const imageObserver = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const targetImg = entry.target;
                        if (targetImg.dataset.src) {
                            // å›¾ç‰‡åŠ è½½å®Œæˆåç§»é™¤è§‚å¯Ÿ
                            targetImg.onload = () => {
                                targetImg.style.opacity = '0';
                                setTimeout(() => {
                                    targetImg.style.transition = 'opacity 0.3s';
                                    targetImg.style.opacity = '1';
                                }, 50);
                            };

                            targetImg.src = targetImg.dataset.src;
                            targetImg.removeAttribute('data-src');
                            imageObserver.unobserve(targetImg);
                        }
                    }
                });
            }, {
                root: null,
                rootMargin: '50px',
                threshold: 0.01
            });

            imageObserver.observe(img);
        }

        // æ£€æŸ¥å…ƒç´ æ˜¯å¦åœ¨è§†å£å†…
        function isVisible(element) {
            const rect = element.getBoundingClientRect();
            return (
                rect.top >= 0 &&
                rect.left >= 0 &&
                rect.bottom <= (window.innerHeight || document.documentElement.clientHeight) &&
                rect.right <= (window.innerWidth || document.documentElement.clientWidth)
            );
        }

        // ä¼˜åŒ–çš„æ¡æ¼«è§†å›¾æ¸²æŸ“
        function renderComicView(images) {
            const fragment = document.createDocumentFragment();

            // è®¡ç®—å…¨å±€ç´¢å¼•åç§»é‡
            const startIndex = (state.currentPage - 1) * state.itemsPerPage;

            images.forEach((image, localIndex) => {
                const globalIndex = startIndex + localIndex;
                const imageItem = createImageItem(image, globalIndex);
                fragment.appendChild(imageItem);
            });

            elements.comicView.innerHTML = '';
            elements.comicView.appendChild(fragment);

            elements.comicView.classList.remove('hidden');
            elements.masonryView.classList.add('hidden');
            elements.folderView.classList.add('hidden');
        }

        // ä¼˜åŒ–çš„æ–‡ä»¶å¤¹è§†å›¾æ¸²æŸ“
        function renderFolderView(images) {
            // ä½¿ç”¨ç¼“å­˜çš„æ–‡ä»¶å¤¹æ•°æ®ï¼Œé¿å…é‡å¤è®¡ç®—
            let folders;
            const cacheKey = images.length;

            if (state.folderCache.has(cacheKey)) {
                folders = state.folderCache.get(cacheKey);
            } else {
                folders = groupImagesByFolder(images);
                state.folderCache.set(cacheKey, folders);
            }

            // ä½¿ç”¨DocumentFragmentä¼˜åŒ–DOMæ“ä½œ
            const fragment = document.createDocumentFragment();

            // é™åˆ¶åŒæ—¶æ¸²æŸ“çš„æ–‡ä»¶å¤¹æ•°é‡ï¼Œæå‡æ€§èƒ½
            const maxFoldersToRender = 20;
            const folderNames = Object.keys(folders).slice(0, maxFoldersToRender);

            folderNames.forEach(folderName => {
                const folderItem = createFolderItem(folders[folderName], folderName);
                fragment.appendChild(folderItem);
            });

            // æ·»åŠ "æ˜¾ç¤ºæ›´å¤š"æç¤ºï¼ˆå¦‚æœæœ‰æ›´å¤šæ–‡ä»¶å¤¹ï¼‰
            if (Object.keys(folders).length > maxFoldersToRender) {
                const moreInfo = document.createElement('div');
                moreInfo.className = 'folder-more-info';
                moreInfo.style.cssText = `
                    text-align: center;
                    padding: 20px;
                    color: #666;
                    font-size: 0.9rem;
                    background: white;
                    border-radius: 8px;
                    margin-bottom: 20px;
                `;
                moreInfo.textContent = `è¿˜æœ‰ ${Object.keys(folders).length - maxFoldersToRender} ä¸ªæ–‡ä»¶å¤¹æœªæ˜¾ç¤ºï¼Œè¯·ä½¿ç”¨æœç´¢åŠŸèƒ½æŸ¥æ‰¾`;
                fragment.appendChild(moreInfo);
            }

            // ä¸€æ¬¡æ€§æ›´æ–°DOM
            elements.folderView.innerHTML = '';
            elements.folderView.appendChild(fragment);

            elements.folderView.classList.remove('hidden');
            elements.masonryView.classList.add('hidden');
        }

        // æŒ‰æ–‡ä»¶å¤¹åˆ†ç»„å›¾ç‰‡
        function groupImagesByFolder(images) {
            const folders = {};
            images.forEach(image => {
                const folderPath = image.folder;
                if (!folders[folderPath]) {
                    folders[folderPath] = [];
                }
                folders[folderPath].push(image);
            });
            return folders;
        }

        // åˆ›å»ºæ–‡ä»¶å¤¹é¡¹å…ƒç´ 
        function createFolderItem(folderImages, folderName) {
            const folderItem = document.createElement('div');
            folderItem.className = 'folder-item';

            // åˆ›å»ºæ–‡ä»¶å¤¹å¤´éƒ¨
            const header = document.createElement('div');
            header.className = 'folder-header';

            const folderNameDiv = document.createElement('div');
            folderNameDiv.className = 'folder-name';

            const folderIcon = document.createElement('span');
            folderIcon.className = 'folder-icon';
            folderIcon.textContent = 'ğŸ“‚';

            const folderNameText = document.createElement('span');
            folderNameText.textContent = folderName;

            const folderCount = document.createElement('div');
            folderCount.className = 'folder-count';
            folderCount.textContent = `${folderImages.length} å¼ å›¾ç‰‡`;

            folderNameDiv.appendChild(folderIcon);
            folderNameDiv.appendChild(folderNameText);
            header.appendChild(folderNameDiv);
            header.appendChild(folderCount);

            // åˆ›å»ºå›¾ç‰‡é¢„è§ˆå®¹å™¨
            const imagesContainer = document.createElement('div');
            imagesContainer.className = 'folder-images';

            // åªåŠ è½½å‰5å¼ å›¾ç‰‡ï¼ˆå‡å°‘é¢„è§ˆæ•°é‡æå‡æ€§èƒ½ï¼‰
            const previewImages = folderImages.slice(0, 5);
            const moreCount = folderImages.length - previewImages.length;

            previewImages.forEach((image, index) => {
                const folderImage = createFolderImage(image, folderName);
                imagesContainer.appendChild(folderImage);
            });

            // å¦‚æœè¿˜æœ‰æ›´å¤šå›¾ç‰‡ï¼Œæ·»åŠ æç¤º
            if (moreCount > 0) {
                const moreInfo = document.createElement('div');
                moreInfo.style.cssText = `
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    color: #666;
                    font-size: 0.9rem;
                    aspect-ratio: 1;
                `;
                moreInfo.textContent = `+${moreCount}`;
                imagesContainer.appendChild(moreInfo);
            }

            // ç»„è£…æ–‡ä»¶å¤¹é¡¹
            folderItem.appendChild(header);
            folderItem.appendChild(imagesContainer);

            // ç»‘å®šå¤´éƒ¨ç‚¹å‡»äº‹ä»¶
            header.addEventListener('click', () => {
                enterFolder(folderName);
            });

            return folderItem;
        }

        // åˆ›å»ºæ–‡ä»¶å¤¹å›¾ç‰‡é¢„è§ˆ
        function createFolderImage(image, folderName) {
            const folderImage = document.createElement('div');
            folderImage.className = 'folder-image';

            const img = document.createElement('img');
            img.src = image.url;
            img.alt = image.name;
            img.loading = 'lazy';

            // æ·»åŠ å›¾ç‰‡åŠ è½½é”™è¯¯å¤„ç†
            img.addEventListener('error', function() {
                this.onerror = null;
                this.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTIwIiBoZWlnaHQ9IjEyMCIgdmlld0JveD0iMCAwIDEyMCAxMjAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxMjAiIGhlaWdodD0iMTIwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik01MCA0MEg3MFo4MFY4MEg1MFY0MFoiIGZpbGw9IiNEMUQxRDEiLz4KPHRleHQgeD0iNjAiIHk9IjkwIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmaWxsPSIjOTk5OTk5IiBmb250LXNpemU9IjEyIiBmb250LWZhbWlseT0iQXJpYWwiPuS4re+8jOWbguOBruS7peWFpeW9kzwvdGV4dD4KPC9zdmc+';
            });

            // ç»‘å®šç‚¹å‡»äº‹ä»¶
            img.addEventListener('click', (e) => {
                e.stopPropagation(); // é˜²æ­¢å†’æ³¡è§¦å‘ header çš„ç‚¹å‡»
                const globalIndex = state.filteredImages.findIndex(item => item.fileKey === image.fileKey);
                if (globalIndex !== -1) {
                    openFullscreen(globalIndex);
                }
            });

            folderImage.appendChild(img);
            return folderImage;
        }

        function openFullscreen(index) {
            state.fullscreenIndex = index;
            const image = state.filteredImages[index];
            resetZoom();
            document.body.classList.add('fullscreen-active');
            elements.fullscreenImage.src = image.url;
            elements.fullscreenCaption.textContent = `${image.name} (${image.path})`;
            elements.fullscreenOverlay.style.display = 'flex';
            updateNavButtons();
        }

        function closeFullscreen() {
            document.body.classList.remove('fullscreen-active');
            elements.fullscreenOverlay.style.display = 'none';
            resetZoom();
        }

        function showPrevImage() {
            if (state.fullscreenIndex > 0) {
                state.fullscreenIndex--;
                switchImage();
            }
        }

        function showNextImage() {
            if (state.fullscreenIndex < state.filteredImages.length - 1) {
                state.fullscreenIndex++;
                switchImage();
            }
        }

        function switchImage() {
            const image = state.filteredImages[state.fullscreenIndex];
            elements.fullscreenImage.src = image.url;
            elements.fullscreenCaption.textContent = `${image.name} (${image.path})`;
            updateNavButtons();
            resetZoom();
        }

        function updateNavButtons() {
            elements.prevBtn.style.display = state.fullscreenIndex > 0 ? 'flex' : 'none';
            elements.nextBtn.style.display = state.fullscreenIndex < state.filteredImages.length - 1 ? 'flex' : 'none';
        }

        function isScrolledToBottom() {
            return window.innerHeight + window.scrollY >= document.documentElement.scrollHeight - 100;
        }

        // è®¾ç½®æ— é™æ»šåŠ¨ç›‘å¬å™¨ - ä¿®å¤ç‰ˆæœ¬
        function setupInfiniteScroll() {
            // å…ˆç§»é™¤æ—§çš„è§¦å‘å™¨
            const oldTrigger = document.getElementById('loadTrigger');
            if (oldTrigger) {
                oldTrigger.remove();
            }

            // æ–­å¼€æ—§çš„è§‚å¯Ÿå™¨
            if (state.infiniteScrollObserver) {
                state.infiniteScrollObserver.disconnect();
            }

            // æ–‡ä»¶å¤¹è§†å›¾ä¸æ”¯æŒæ— é™æ»šåŠ¨ï¼Œå› ä¸ºå®ƒä¸åˆ†é¡µ
            if (state.currentView === 'folder' && !state.activeFolder) {
                return; // æ–‡ä»¶å¤¹è§†å›¾ä¸éœ€è¦æ— é™æ»šåŠ¨
            }

            // æ£€æŸ¥æ˜¯å¦è¿˜æœ‰æ›´å¤šå†…å®¹
            const hasMoreContent = state.currentPage * state.itemsPerPage < state.filteredImages.length;

            // å¦‚æœæ²¡æœ‰æ›´å¤šå†…å®¹ï¼Œç›´æ¥è¿”å›
            if (!hasMoreContent) {
                return;
            }

            // åˆ›å»ºåŠ è½½æŒ‡ç¤ºå™¨
            const loadTrigger = document.createElement('div');
            loadTrigger.id = 'loadTrigger';
            loadTrigger.style.cssText = `
                height: 100px;
                min-height: 100px;
                display: flex;
                align-items: center;
                justify-content: center;
                color: #666;
                font-size: 0.9rem;
                pointer-events: none;
                width: 100%;
                margin-top: 20px;
                clear: both;
            `;
            loadTrigger.innerHTML = '<span>æ»šåŠ¨æˆ–ç‚¹å‡»åŠ è½½æ›´å¤š...</span>';

            // æ ¹æ®å½“å‰è§†å›¾é€‰æ‹©åˆé€‚çš„å®¹å™¨
            let container;
            if (state.currentView === 'grid') {
                container = elements.masonryView;
            } else if (state.currentView === 'comic') {
                container = elements.comicView;
            } else {
                // åœ¨activeFolderæ¨¡å¼ä¸‹ï¼Œä½¿ç”¨ç½‘æ ¼è§†å›¾å®¹å™¨
                container = elements.masonryView;
            }

            if (container && container.style.display !== 'none') {
                container.appendChild(loadTrigger);
            } else {
                document.body.appendChild(loadTrigger);
            }

            // ç§»é™¤è‡ªåŠ¨æ»šåŠ¨åˆ°è§¦å‘å™¨çš„é€»è¾‘ï¼Œé¿å…æ„å¤–æ»šåŠ¨
            // setTimeout(() => {
            //     if (!isVisible(loadTrigger)) {
            //         // å¦‚æœè§¦å‘å™¨ä¸å¯è§ï¼Œæ»šåŠ¨åˆ°è§¦å‘å™¨ä½ç½®
            //         loadTrigger.scrollIntoView({ behavior: 'smooth', block: 'end' });
            //     }
            // }, 100);

            // ä½¿ç”¨Intersection Observerç›‘å¬æ»šåŠ¨åˆ°åº•éƒ¨
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting && !state.isLoading && hasMoreContent) {
                        // æ£€æŸ¥æ˜¯å¦åœ¨ä¿æŠ¤æœŸå†…
                        const now = Date.now();
                        const isInProtectionPeriod = viewSwitchProtection.isSwitching &&
                            (now - viewSwitchProtection.startTime) < viewSwitchProtection.protectionDuration;

                        if (!isInProtectionPeriod) {
                            loadMoreImagesOptimized();
                        } else {
                            console.log('åœ¨è§†å›¾åˆ‡æ¢ä¿æŠ¤æœŸå†…ï¼Œè·³è¿‡Intersection Observerè§¦å‘çš„è‡ªåŠ¨åŠ è½½');
                        }
                    }
                });
            }, {
                root: null,
                rootMargin: '100px', // é¢„åŠ è½½è·ç¦»
                threshold: 0.01 // é™ä½é˜ˆå€¼ï¼Œæ›´å®¹æ˜“è§¦å‘
            });

            // è§‚å¯ŸåŠ è½½è§¦å‘å™¨
            observer.observe(loadTrigger);

            // æ¸…ç†å‡½æ•°
            state.infiniteScrollObserver = observer;

            // æ·»åŠ ç‚¹å‡»åŠ è½½åŠŸèƒ½ä½œä¸ºå¤‡é€‰æ–¹æ¡ˆ
            loadTrigger.style.cursor = 'pointer';
            loadTrigger.style.pointerEvents = 'auto';
            loadTrigger.addEventListener('click', () => {
                if (!state.isLoading && hasMoreContent) {
                    loadMoreImagesOptimized();
                }
            });

            // æ£€æŸ¥æ˜¯å¦éœ€è¦ç«‹å³åŠ è½½æ›´å¤šå†…å®¹
            // ä½¿ç”¨æ›´å¼ºçš„ä¿æŠ¤æœºåˆ¶é¿å…åœ¨è§†å›¾åˆ‡æ¢æ—¶è‡ªåŠ¨è§¦å‘
            setTimeout(() => {
                const now = Date.now();
                const isInProtectionPeriod = viewSwitchProtection.isSwitching &&
                    (now - viewSwitchProtection.startTime) < viewSwitchProtection.protectionDuration;

                if (hasMoreContent && !state.isLoading && !state.isViewSwitching && !isInProtectionPeriod) {
                    const pageHeight = document.documentElement.scrollHeight;
                    const viewportHeight = window.innerHeight;
                    const isPageScrollable = pageHeight > viewportHeight + 50;

                    // åªæœ‰åœ¨é¡µé¢å†…å®¹ç¡®å®æ˜æ˜¾ä¸è¶³æ—¶æ‰è‡ªåŠ¨åŠ è½½
                    if (!isPageScrollable && pageHeight < viewportHeight * 0.4) {
                        console.log('é¡µé¢å†…å®¹æ˜æ˜¾ä¸è¶³ï¼Œè‡ªåŠ¨åŠ è½½æ›´å¤š...');
                        loadMoreImagesOptimized();
                    }
                } else if (isInProtectionPeriod) {
                    console.log('åœ¨è§†å›¾åˆ‡æ¢ä¿æŠ¤æœŸå†…ï¼Œè·³è¿‡è‡ªåŠ¨åŠ è½½');
                }
            }, 800);
        }

        // ä¼˜åŒ–çš„åŠ è½½æ›´å¤šå›¾ç‰‡
        function loadMoreImagesOptimized() {
            if (state.currentPage * state.itemsPerPage >= state.filteredImages.length) {
                // ç§»é™¤åŠ è½½è§¦å‘å™¨ï¼Œå› ä¸ºæ²¡æœ‰æ›´å¤šå†…å®¹äº†
                const loadTrigger = document.getElementById('loadTrigger');
                if (loadTrigger) {
                    loadTrigger.remove();
                }
                return;
            }

            // é˜²æ­¢é‡å¤åŠ è½½
            if (state.isLoading) return;

            state.isLoading = true;
            elements.loadingIndicator.classList.remove('hidden');

            // ä¸´æ—¶éšè—è§¦å‘å™¨ï¼Œé¿å…é‡å¤ç‚¹å‡»
            const loadTrigger = document.getElementById('loadTrigger');
            if (loadTrigger) {
                loadTrigger.innerHTML = '<span>æ­£åœ¨åŠ è½½...</span>';
                loadTrigger.style.pointerEvents = 'none';
            }

            // ä½¿ç”¨requestAnimationFrameä¼˜åŒ–æ€§èƒ½
            requestAnimationFrame(() => {
                state.currentPage++;

                // è°ƒç”¨ç»Ÿä¸€çš„renderImageså‡½æ•°ï¼Œè®©å®ƒå¤„ç†æ‰€æœ‰è§†å›¾æ¨¡å¼çš„æ¸²æŸ“
                renderImages();

                elements.loadingIndicator.classList.add('hidden');
                state.isLoading = false;

                // æ£€æŸ¥æ˜¯å¦è¿˜æœ‰æ›´å¤šå†…å®¹
                const hasMore = state.currentPage * state.itemsPerPage < state.filteredImages.length;

                if (!hasMore) {
                    // æ²¡æœ‰æ›´å¤šå†…å®¹ï¼Œç§»é™¤è§¦å‘å™¨
                    const trigger = document.getElementById('loadTrigger');
                    if (trigger) {
                        trigger.innerHTML = '<span>å·²åŠ è½½å…¨éƒ¨å›¾ç‰‡</span>';
                        trigger.style.pointerEvents = 'none';
                    }
                } else {
                    // é‡æ–°è®¾ç½®æ— é™æ»šåŠ¨ï¼Œç¡®ä¿æ–°çš„è§¦å‘å™¨ä½ç½®æ­£ç¡®
                    setTimeout(() => {
                        setupInfiniteScroll();
                    }, 100);
                }
            });
        }

        // æ—§ç‰ˆæœ¬ä¿ç•™ä½œä¸ºå¤‡ç”¨
        function loadMoreImages() {
            loadMoreImagesOptimized();
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // æ›´æ–°è¿”å›ç½®é¡¶æŒ‰é’®æ˜¾ç¤ºçŠ¶æ€
        function updateBackToTopButton() {
            if (window.scrollY > 300) {
                elements.backToTop.classList.add('visible');
            } else {
                elements.backToTop.classList.remove('visible');
            }
        }

        init();
    </script>
</body>
</html>